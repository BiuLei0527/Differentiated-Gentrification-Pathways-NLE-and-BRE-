"0","# ============================================="
"0","# åŠ¨æ€ç»…å£«åŒ–æŒ‡æ•°åˆ†æï¼ˆä¿®å¤ç‰ˆï¼‰"
"0","# ============================================="
"0","library(tidyverse)"
"0","library(sf)"
"0","library(ggspatial)"
"0","library(RColorBrewer)"
"0",""
"0","# åˆ›å»ºè¾“å‡ºç›®å½•"
"0","if(!dir.exists(""gentrification_result"")) {"
"0","  dir.create(""gentrification_result"")"
"0","}"
"0",""
"0","# ============================================="
"0","# åŠ¨æ€ç»…å£«åŒ–æŒ‡æ•°è®¡ç®—å‡½æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰"
"0","# ============================================="
"0","calculate_dynamic_gentrification_index <- function(panel_data, treatment_year, project_name) {"
"0","  cat(paste0(""\n=== åŠ¨æ€ç»…å£«åŒ–æŒ‡æ•° - "", project_name, "" ===\n""))"
"0","  cat(""å…¬å¼: åŠ¨æ€æŒ‡æ•° = åŸºäºæ•°æ®è‡ªç„¶åˆ†å¸ƒçš„åŠ æƒåˆæˆ\n"")"
"0","  cat(""æŒ‡æ•°èŒƒå›´: æ ¹æ®å®é™…æ•°æ®åˆ†å¸ƒç¡®å®šï¼Œæ— äººä¸ºçº¦æŸ\n"")"
"0","  "
"0","  panel_data_no_geo <- panel_data %>% st_drop_geometry()"
"0","  baseline_year <- treatment_year - 1"
"0","  "
"0","  # æ•°æ®è¯Šæ–­"
"0","  cat(""\n=== æ•°æ®è¯Šæ–­ ===\n"")"
"0","  cat(""æ•°æ®å¹´ä»½èŒƒå›´:"", min(panel_data_no_geo$year), ""åˆ°"", max(panel_data_no_geo$year), ""\n"")"
"0","  cat(""åŸºçº¿å¹´ä»½:"", baseline_year, ""\n"")"
"0","  cat(""åˆ†æå¹´ä»½:"", max(panel_data_no_geo$year), ""\n"")"
"0","  cat(""æ€»æ•°æ®è¡Œæ•°:"", nrow(panel_data_no_geo), ""\n"")"
"0","  cat(""å”¯ä¸€LSOAæ•°é‡:"", length(unique(panel_data_no_geo$LSOA11CD)), ""\n"")"
"0","  "
"0","  # æ£€æŸ¥å…³é”®å¹´ä»½æ•°æ®"
"0","  baseline_lsoas <- panel_data_no_geo %>% filter(year == baseline_year) %>% pull(LSOA11CD)"
"0","  latest_lsoas <- panel_data_no_geo %>% filter(year == max(year)) %>% pull(LSOA11CD)"
"0","  common_lsoas <- intersect(baseline_lsoas, latest_lsoas)"
"0","  "
"0","  cat(""åŸºçº¿å¹´LSOAæ•°é‡:"", length(baseline_lsoas), ""\n"")"
"0","  cat(""æœ€æ–°å¹´LSOAæ•°é‡:"", length(latest_lsoas), ""\n"")"
"0","  cat(""ä¸¤å¹´éƒ½æœ‰æ•°æ®çš„LSOA:"", length(common_lsoas), ""\n"")"
"0","  "
"0","  # æ£€æŸ¥çŠ¯ç½ªç‡æ•°æ®è´¨é‡"
"0","  cat(""\n=== çŠ¯ç½ªç‡æ•°æ®æ£€æŸ¥ ===\n"")"
"0","  crime_check <- panel_data_no_geo %>%"
"0","    filter(year %in% c(baseline_year, max(year))) %>%"
"0","    group_by(year) %>%"
"0","    summarise("
"0","      crime_min = min(`crime rate`, na.rm = TRUE),"
"0","      crime_max = max(`crime rate`, na.rm = TRUE),"
"0","      crime_mean = round(mean(`crime rate`, na.rm = TRUE), 4),"
"0","      crime_zero_count = sum(`crime rate` == 0, na.rm = TRUE),"
"0","      total_count = n(),"
"0","      .groups = 'drop'"
"0","    )"
"0","  print(crime_check)"
"0","  "
"0","  # è®¡ç®—å˜åŒ–æ•°æ®"
"0","  latest_year <- max(panel_data_no_geo$year)"
"0","  "
"0","  # è·å–åŸºçº¿å¹´å’Œæœ€æ–°å¹´çš„æ•°æ®"
"0","  baseline_data <- panel_data_no_geo %>%"
"0","    filter(year == baseline_year) %>%"
"0","    select(LSOA11CD, "
"0","           baseline_income = lsoa_income_estimate,"
"0","           baseline_price = median_price,"
"0","           baseline_mobility = mobility,"
"0","           baseline_crime = `crime rate`)"
"0","  "
"0","  latest_data <- panel_data_no_geo %>%"
"0","    filter(year == latest_year) %>%"
"0","    select(LSOA11CD,"
"0","           latest_income = lsoa_income_estimate,"
"0","           latest_price = median_price,"
"0","           latest_mobility = mobility,"
"0","           latest_crime = `crime rate`)"
"0","  "
"0","  # åˆå¹¶æ•°æ®"
"0","  change_data <- baseline_data %>%"
"0","    inner_join(latest_data, by = ""LSOA11CD"") %>%"
"0","    mutate("
"0","      # æ”¶å…¥å˜åŒ–ç‡"
"0","      income_change_rate = ifelse(baseline_income > 0,"
"0","                                  (latest_income - baseline_income) / baseline_income, 0),"
"0","      "
"0","      # æˆ¿ä»·å˜åŒ–ç‡"
"0","      price_change_rate = ifelse(baseline_price > 0,"
"0","                                (latest_price - baseline_price) / baseline_price, 0),"
"0","      "
"0","      # æµåŠ¨æ€§å˜åŒ–ï¼ˆç›´æ¥å·®å€¼ï¼‰"
"0","      mobility_change = latest_mobility - baseline_mobility,"
"0","      "
"0","      # çŠ¯ç½ªç‡æ”¹å–„"
"0","      crime_improvement_rate = case_when("
"0","        baseline_crime == 0 & latest_crime == 0 ~ 0,"
"0","        baseline_crime == 0 & latest_crime > 0 ~ -1,"
"0","        latest_crime == 0 & baseline_crime > 0 ~ 1,"
"0","        baseline_crime > 0 & latest_crime > 0 ~ (baseline_crime - latest_crime) / baseline_crime,"
"0","        TRUE ~ 0"
"0","      ),"
"0","      "
"0","      # æ ‡è®°æ•°æ®è´¨é‡"
"0","      has_valid_income = !is.na(income_change_rate) & is.finite(income_change_rate),"
"0","      has_valid_price = !is.na(price_change_rate) & is.finite(price_change_rate),"
"0","      has_valid_mobility = !is.na(mobility_change) & is.finite(mobility_change),"
"0","      has_valid_crime = !is.na(crime_improvement_rate) & is.finite(crime_improvement_rate)"
"0","    )"
"0","  "
"0","  # æ˜¾ç¤ºæ•°æ®è´¨é‡ç»Ÿè®¡"
"0","  cat(""\n=== æ•°æ®è´¨é‡ç»Ÿè®¡ ===\n"")"
"0","  quality_stats <- change_data %>%"
"0","    summarise("
"0","      total_lsoas = n(),"
"0","      valid_income = sum(has_valid_income),"
"0","      valid_price = sum(has_valid_price),"
"0","      valid_mobility = sum(has_valid_mobility),"
"0","      valid_crime = sum(has_valid_crime),"
"0","      zero_baseline_crime = sum(baseline_crime == 0),"
"0","      complete_data = sum(has_valid_income & has_valid_price & has_valid_mobility & has_valid_crime)"
"0","    )"
"0","  print(quality_stats)"
"0","  "
"0","  # å¤„ç†æ— æ•ˆå€¼"
"0","  valid_data <- change_data %>%"
"0","    mutate("
"0","      income_change_rate = ifelse(is.finite(income_change_rate), income_change_rate, 0),"
"0","      price_change_rate = ifelse(is.finite(price_change_rate), price_change_rate, 0),"
"0","      mobility_change = ifelse(is.finite(mobility_change), mobility_change, 0),"
"0","      crime_improvement_rate = ifelse(is.finite(crime_improvement_rate), crime_improvement_rate, 0)"
"0","    )"
"0","  "
"0","  cat(""\nä¿ç•™çš„LSOAæ•°é‡:"", nrow(valid_data), ""\n"")"
"0","  "
"0","  if(nrow(valid_data) == 0) {"
"0","    cat(""âŒ é”™è¯¯: æ²¡æœ‰æ•°æ®\n"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # æ˜¾ç¤ºå˜åŒ–ç‡åˆ†å¸ƒ"
"0","  cat(""\n=== å˜åŒ–ç‡åˆ†å¸ƒ ===\n"")"
"0","  change_summary <- valid_data %>%"
"0","    summarise("
"0","      income_mean = round(mean(income_change_rate, na.rm = TRUE) * 100, 1),"
"0","      income_sd = round(sd(income_change_rate, na.rm = TRUE) * 100, 1),"
"0","      price_mean = round(mean(price_change_rate, na.rm = TRUE) * 100, 1),"
"0","      price_sd = round(sd(price_change_rate, na.rm = TRUE) * 100, 1),"
"0","      mobility_mean = round(mean(mobility_change, na.rm = TRUE), 3),"
"0","      mobility_sd = round(sd(mobility_change, na.rm = TRUE), 3),"
"0","      crime_mean = round(mean(crime_improvement_rate, na.rm = TRUE) * 100, 1),"
"0","      crime_sd = round(sd(crime_improvement_rate, na.rm = TRUE) * 100, 1)"
"0","    )"
"0","  print(change_summary)"
"0","  "
"0","  # è®¡ç®—æ ‡å‡†åŒ–åˆ†æ•°"
"0","  valid_data <- valid_data %>%"
"0","    mutate("
"0","      # æ–¹æ³•1: ç™¾åˆ†ä½æ•°æ’åæ³• (0-100è‡ªç„¶åˆ†å¸ƒ)"
"0","      income_percentile = percent_rank(income_change_rate) * 100,"
"0","      price_percentile = percent_rank(price_change_rate) * 100,"
"0","      mobility_percentile = percent_rank(mobility_change) * 100,"
"0","      crime_percentile = percent_rank(crime_improvement_rate) * 100,"
"0","      "
"0","      # æ–¹æ³•2: Min-Maxæ ‡å‡†åŒ– (0-100çº¿æ€§æ˜ å°„)"
"0","      income_minmax = {"
"0","        range_val = max(income_change_rate, na.rm = TRUE) - min(income_change_rate, na.rm = TRUE)"
"0","        if(range_val > 0) {"
"0","          (income_change_rate - min(income_change_rate, na.rm = TRUE)) / range_val * 100"
"0","        } else {"
"0","          rep(50, length(income_change_rate))"
"0","        }"
"0","      },"
"0","      price_minmax = {"
"0","        range_val = max(price_change_rate, na.rm = TRUE) - min(price_change_rate, na.rm = TRUE)"
"0","        if(range_val > 0) {"
"0","          (price_change_rate - min(price_change_rate, na.rm = TRUE)) / range_val * 100"
"0","        } else {"
"0","          rep(50, length(price_change_rate))"
"0","        }"
"0","      },"
"0","      mobility_minmax = {"
"0","        range_val = max(mobility_change, na.rm = TRUE) - min(mobility_change, na.rm = TRUE)"
"0","        if(range_val > 0) {"
"0","          (mobility_change - min(mobility_change, na.rm = TRUE)) / range_val * 100"
"0","        } else {"
"0","          rep(50, length(mobility_change))"
"0","        }"
"0","      },"
"0","      crime_minmax = {"
"0","        range_val = max(crime_improvement_rate, na.rm = TRUE) - min(crime_improvement_rate, na.rm = TRUE)"
"0","        if(range_val > 0) {"
"0","          (crime_improvement_rate - min(crime_improvement_rate, na.rm = TRUE)) / range_val * 100"
"0","        } else {"
"0","          rep(50, length(crime_improvement_rate))"
"0","        }"
"0","      },"
"0","      "
"0","      # æ–¹æ³•3: Z-scoreæ ‡å‡†åŒ–"
"0","      income_z = scale(income_change_rate)[,1],"
"0","      price_z = scale(price_change_rate)[,1],"
"0","      mobility_z = scale(mobility_change)[,1],"
"0","      crime_z = scale(crime_improvement_rate)[,1],"
"0","      "
"0","      # Z-scoreè½¬æ¢ä¸º0-100"
"0","      income_z_scaled = pnorm(income_z) * 100,"
"0","      price_z_scaled = pnorm(price_z) * 100,"
"0","      mobility_z_scaled = pnorm(mobility_z) * 100,"
"0","      crime_z_scaled = pnorm(crime_z) * 100,"
"0","      "
"0","      # è®¡ç®—ä¸‰ç§ä¸åŒçš„ç»¼åˆæŒ‡æ•°"
"0","      index_percentile = (income_percentile * 0.30 + price_percentile * 0.30 +"
"0","                         mobility_percentile * 0.25 + crime_percentile * 0.15),"
"0","      "
"0","      index_minmax = (income_minmax * 0.30 + price_minmax * 0.30 +"
"0","                     mobility_minmax * 0.25 + crime_minmax * 0.15),"
"0","      "
"0","      index_zscore = (income_z_scaled * 0.30 + price_z_scaled * 0.30 +"
"0","                     mobility_z_scaled * 0.25 + crime_z_scaled * 0.15),"
"0","      "
"0","      # é»˜è®¤ä½¿ç”¨ç™¾åˆ†ä½æ•°æ³•"
"0","      dynamic_index = index_percentile,"
"0","      "
"0","      # é¡¹ç›®ä¿¡æ¯"
"0","      project = project_name,"
"0","      method = ""Percentile_Ranking"","
"0","      baseline_year = baseline_year,"
"0","      analysis_year = latest_year"
"0","    )"
"0","  "
"0","  # æ˜¾ç¤ºä¸‰ç§æ–¹æ³•çš„ç»“æœæ¯”è¾ƒ"
"0","  cat(""\n=== ä¸‰ç§æŒ‡æ•°æ–¹æ³•æ¯”è¾ƒ ===\n"")"
"0","  method_comparison <- valid_data %>%"
"0","    summarise("
"0","      percentile_min = round(min(index_percentile, na.rm = TRUE), 1),"
"0","      percentile_max = round(max(index_percentile, na.rm = TRUE), 1),"
"0","      percentile_mean = round(mean(index_percentile, na.rm = TRUE), 1),"
"0","      percentile_sd = round(sd(index_percentile, na.rm = TRUE), 1),"
"0","      "
"0","      minmax_min = round(min(index_minmax, na.rm = TRUE), 1),"
"0","      minmax_max = round(max(index_minmax, na.rm = TRUE), 1),"
"0","      minmax_mean = round(mean(index_minmax, na.rm = TRUE), 1),"
"0","      minmax_sd = round(sd(index_minmax, na.rm = TRUE), 1),"
"0","      "
"0","      zscore_min = round(min(index_zscore, na.rm = TRUE), 1),"
"0","      zscore_max = round(max(index_zscore, na.rm = TRUE), 1),"
"0","      zscore_mean = round(mean(index_zscore, na.rm = TRUE), 1),"
"0","      zscore_sd = round(sd(index_zscore, na.rm = TRUE), 1)"
"0","    )"
"0","  "
"0","  cat(""ç™¾åˆ†ä½æ•°æ³•: èŒƒå›´"", method_comparison$percentile_min, ""-"", method_comparison$percentile_max,"
"0","      ""| å‡å€¼"", method_comparison$percentile_mean, ""| æ ‡å‡†å·®"", method_comparison$percentile_sd, ""\n"")"
"0","  cat(""Min-Maxæ³•:   èŒƒå›´"", method_comparison$minmax_min, ""-"", method_comparison$minmax_max,"
"0","      ""| å‡å€¼"", method_comparison$minmax_mean, ""| æ ‡å‡†å·®"", method_comparison$minmax_sd, ""\n"")"
"0","  cat(""Z-scoreæ³•:   èŒƒå›´"", method_comparison$zscore_min, ""-"", method_comparison$zscore_max,"
"0","      ""| å‡å€¼"", method_comparison$zscore_mean, ""| æ ‡å‡†å·®"", method_comparison$zscore_sd, ""\n"")"
"0","  "
"0","  # é€‰æ‹©æœ€ä½³æ–¹æ³•"
"0","  cat(""\n=== æ–¹æ³•é€‰æ‹©å»ºè®® ===\n"")"
"0","  n_areas <- nrow(valid_data)"
"0","  "
"0","  if(n_areas <= 5) {"
"0","    valid_data$dynamic_index <- valid_data$index_minmax"
"0","    valid_data$method <- ""MinMax_Small_Sample"""
"0","    cat(""âœ“ é€‰æ‹©Min-Maxæ³• (é€‚åˆå°æ ·æœ¬"", n_areas, ""ä¸ªåŒºåŸŸ)\n"")"
"0","  } else if(n_areas <= 20) {"
"0","    valid_data$dynamic_index <- valid_data$index_percentile"
"0","    valid_data$method <- ""Percentile_Medium_Sample"""
"0","    cat(""âœ“ é€‰æ‹©ç™¾åˆ†ä½æ•°æ³• (é€‚åˆä¸­ç­‰æ ·æœ¬"", n_areas, ""ä¸ªåŒºåŸŸ)\n"")"
"0","  } else {"
"0","    valid_data$dynamic_index <- valid_data$index_zscore"
"0","    valid_data$method <- ""ZScore_Large_Sample"""
"0","    cat(""âœ“ é€‰æ‹©Z-scoreæ³• (é€‚åˆå¤§æ ·æœ¬"", n_areas, ""ä¸ªåŒºåŸŸ)\n"")"
"0","  }"
"0","  "
"0","  # æ˜¾ç¤ºåˆ†ç±»ç»Ÿè®¡"
"0","  cat(""\n=== ç»…å£«åŒ–ç¨‹åº¦åˆ†ç±» ===\n"")"
"0","  classification <- valid_data %>%"
"0","    mutate("
"0","      gent_level = case_when("
"0","        dynamic_index >= 80 ~ ""é«˜åº¦ç»…å£«åŒ–"","
"0","        dynamic_index >= 70 ~ ""ä¸­åº¦ç»…å£«åŒ–"","
"0","        dynamic_index >= 60 ~ ""è½»åº¦ç»…å£«åŒ–"","
"0","        TRUE ~ ""ç›¸å¯¹ç¨³å®š"""
"0","      )"
"0","    ) %>%"
"0","    count(gent_level, sort = TRUE)"
"0","  print(classification)"
"0","  "
"0","  # æ˜¾ç¤ºè¯¦ç»†æ¡ˆä¾‹ï¼ˆä¿®å¤ç‰ˆï¼‰"
"0","  cat(""\n=== è¯¦ç»†æ¡ˆä¾‹ï¼ˆå‰5ä¸ªLSOAï¼‰===\n"")"
"0","  sample_detailed <- valid_data %>%"
"0","    select(LSOA11CD,"
"0","           income_change_rate, price_change_rate, mobility_change, crime_improvement_rate,"
"0","           income_percentile, price_percentile, mobility_percentile, crime_percentile,"
"0","           dynamic_index) %>%"
"0","    slice_head(n = 5) %>%"
"0","    mutate(across(where(is.numeric), ~round(.x, 2)))"
"0","  print(sample_detailed)"
"0","  "
"0","  # æ˜¾ç¤ºå„æŒ‡æ ‡çš„å®é™…è´¡çŒ®"
"0","  cat(""\n=== å„æŒ‡æ ‡å®é™…è´¡çŒ®åˆ†æ ===\n"")"
"0","  contributions <- valid_data %>%"
"0","    mutate("
"0","      income_contrib = income_percentile * 0.30,"
"0","      price_contrib = price_percentile * 0.30,"
"0","      mobility_contrib = mobility_percentile * 0.25,"
"0","      crime_contrib = crime_percentile * 0.15"
"0","    ) %>%"
"0","    summarise("
"0","      avg_income_contrib = round(mean(income_contrib, na.rm = TRUE), 2),"
"0","      avg_price_contrib = round(mean(price_contrib, na.rm = TRUE), 2),"
"0","      avg_mobility_contrib = round(mean(mobility_contrib, na.rm = TRUE), 2),"
"0","      avg_crime_contrib = round(mean(crime_contrib, na.rm = TRUE), 2)"
"0","    )"
"0","  "
"0","  total_contrib <- sum(contributions)"
"0","  cat(""æ”¶å…¥å¹³å‡è´¡çŒ®:"", contributions$avg_income_contrib,"
"0","      "" ("", round(contributions$avg_income_contrib/total_contrib*100, 1), ""%)\n"")"
"0","  cat(""æˆ¿ä»·å¹³å‡è´¡çŒ®:"", contributions$avg_price_contrib,"
"0","      "" ("", round(contributions$avg_price_contrib/total_contrib*100, 1), ""%)\n"")"
"0","  cat(""æµåŠ¨æ€§å¹³å‡è´¡çŒ®:"", contributions$avg_mobility_contrib,"
"0","      "" ("", round(contributions$avg_mobility_contrib/total_contrib*100, 1), ""%)\n"")"
"0","  cat(""çŠ¯ç½ªç‡å¹³å‡è´¡çŒ®:"", contributions$avg_crime_contrib,"
"0","      "" ("", round(contributions$avg_crime_contrib/total_contrib*100, 1), ""%)\n"")"
"0","  "
"0","  return(valid_data)"
"0","}"
"0",""
"0","# ============================================="
"0","# åœ°å›¾å¯è§†åŒ–å‡½æ•°"
"0","# ============================================="
"0","create_gentrification_map <- function(panel_data, gentrification_data, project_name,"
"0","                                     station_location = NULL) {"
"0","  "
"0","  cat(paste0(""\nç”Ÿæˆ "", project_name, "" ç»…å£«åŒ–åœ°å›¾...\n""))"
"0","  "
"0","  # è·å–å‡ ä½•æ•°æ®"
"0","  spatial_geometry <- panel_data %>%"
"0","    filter(year == max(year)) %>%"
"0","    select(LSOA11CD, geometry) %>%"
"0","    distinct(LSOA11CD, .keep_all = TRUE)"
"0","  "
"0","  # åˆå¹¶æ•°æ®"
"0","  map_data <- gentrification_data %>%"
"0","    left_join(spatial_geometry, by = ""LSOA11CD"") %>%"
"0","    st_as_sf()"
"0","  "
"0","  # åˆ›å»ºåˆ†ç±»"
"0","  map_data <- map_data %>%"
"0","    mutate("
"0","      gent_quartile = ntile(dynamic_index, 4),"
"0","      gent_category = case_when("
"0","        gent_quartile == 4 ~ ""High (Q4)"","
"0","        gent_quartile == 3 ~ ""Medium-High (Q3)"","
"0","        gent_quartile == 2 ~ ""Medium-Low (Q2)"","
"0","        TRUE ~ ""Low (Q1)"""
"0","      ),"
"0","      display_label = paste0(LSOA11CD, ""\n"", round(dynamic_index, 1))"
"0","    )"
"0","  "
"0","  # è®¾ç½®ç«™ç‚¹ä½ç½®"
"0","  if(is.null(station_location)) {"
"0","    station_location <- st_centroid(st_union(map_data))"
"0","  }"
"0","  "
"0","  # åˆ›å»ºåœ°å›¾"
"0","  p_map <- ggplot() +"
"0","    geom_sf(data = map_data,"
"0","            aes(fill = dynamic_index),"
"0","            color = ""white"", size = 0.4, alpha = 0.9) +"
"0","    "
"0","    # ç«™ç‚¹"
"0","    geom_sf(data = station_location,"
"0","            color = ""black"", fill = ""yellow"","
"0","            size = 8, shape = 23, stroke = 3) +"
"0","    "
"0","    # æ ‡ç­¾"
"0","    geom_sf_text(data = map_data,"
"0","                aes(label = display_label),"
"0","                size = 3, color = ""black"", fontface = ""bold"") +"
"0","    "
"0","    # é¢œè‰²èŒƒå›´"
"0","    scale_fill_gradient2("
"0","      low = ""#2166AC"","
"0","      mid = ""#F7F7F7"","
"0","      high = ""#A50026"","
"0","      midpoint = mean(map_data$dynamic_index, na.rm = TRUE),"
"0","      limits = c("
"0","        floor(min(map_data$dynamic_index, na.rm = TRUE) / 10) * 10,"
"0","        ceiling(max(map_data$dynamic_index, na.rm = TRUE) / 10) * 10"
"0","      ),"
"0","      breaks = pretty(range(map_data$dynamic_index, na.rm = TRUE), n = 5),"
"0","      name = ""Dynamic\nGentrification\nIndex"","
"0","      guide = guide_colorbar("
"0","        barwidth = 2.5,"
"0","        barheight = 20,"
"0","        title.position = ""top"","
"0","        title.hjust = 0.5"
"0","      )"
"0","    ) +"
"0","    "
"0","    # æŒ‡åŒ—é’ˆå’Œæ¯”ä¾‹å°º"
"0","    annotation_north_arrow("
"0","      location = ""tr"","
"0","      pad_x = unit(0.3, ""cm""),"
"0","      pad_y = unit(0.3, ""cm"")"
"0","    ) +"
"0","    "
"0","    annotation_scale("
"0","      location = ""bl"","
"0","      width_hint = 0.25"
"0","    ) +"
"0","    "
"0","    labs("
"0","      title = paste0(project_name, "": Dynamic Gentrification Index""),"
"0","      subtitle = paste0("
"0","        ""Method: "", unique(gentrification_data$method),"
"0","        "" | Baseline: "", unique(gentrification_data$baseline_year),"
"0","        "" â†’ Analysis: "", unique(gentrification_data$analysis_year),"
"0","        "" | Mean: "", round(mean(gentrification_data$dynamic_index, na.rm = TRUE), 1),"
"0","        "" | Range: "", round(min(gentrification_data$dynamic_index, na.rm = TRUE), 1),"
"0","        ""-"", round(max(gentrification_data$dynamic_index, na.rm = TRUE), 1)"
"0","      ),"
"0","      caption = ""Index uses adaptive method based on sample size"""
"0","    ) +"
"0","    "
"0","    theme_void() +"
"0","    theme("
"0","      plot.title = element_text(size = 18, face = ""bold"", hjust = 0.5),"
"0","      plot.subtitle = element_text(size = 14, hjust = 0.5, color = ""#555""),"
"0","      plot.caption = element_text(size = 10, hjust = 0.5, color = ""#333""),"
"0","      legend.position = ""right"""
"0","    )"
"0","  "
"0","  return(list(map = p_map, data = map_data))"
"0","}"
"0",""
"0","# ============================================="
"0","# ä¸»æ‰§è¡Œå‡½æ•°"
"0","# ============================================="
"0","run_gentrification_analysis <- function(panel_data, treatment_year, project_name,"
"0","                                       station_location = NULL) {"
"0","  "
"0","  cat(paste0(""\n========== "", project_name, "" ç»…å£«åŒ–åˆ†æ ==========\n""))"
"0","  "
"0","  # è®¡ç®—æŒ‡æ•°"
"0","  results <- calculate_dynamic_gentrification_index(panel_data, treatment_year, project_name)"
"0","  "
"0","  if(is.null(results)) {"
"0","    cat(""åˆ†æå¤±è´¥\n"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # åˆ›å»ºåœ°å›¾"
"0","  map_results <- create_gentrification_map(panel_data, results, project_name, station_location)"
"0","  "
"0","  if(is.null(map_results)) {"
"0","    cat(""åœ°å›¾åˆ›å»ºå¤±è´¥\n"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # ä¿å­˜æ–‡ä»¶"
"0","  ggsave("
"0","    paste0(""gentrification_result/"", project_name, ""_Gentrification_Natural.png""),"
"0","    map_results$map, width = 16, height = 12, dpi = 300, bg = ""white"""
"0","  )"
"0","  "
"0","  write.csv("
"0","    results,"
"0","    paste0(""gentrification_result/"", project_name, ""_Gentrification_data_natural.csv""),"
"0","    row.names = FALSE"
"0","  )"
"0","  "
"0","  cat(""âœ… åˆ†æå®Œæˆï¼æ–‡ä»¶å·²ä¿å­˜\n"")"
"0","  "
"0","  return(list(data = results, map = map_results))"
"0","}"
"0",""
"0","# ============================================="
"0","# æ‰§è¡Œåˆ†æ"
"0","# ============================================="
"0","cat(""\nğŸš€ å¼€å§‹è‡ªç„¶ç»…å£«åŒ–åˆ†æ...\n"")"
"1","
ğŸš€ å¼€å§‹è‡ªç„¶ç»…å£«åŒ–åˆ†æ...
"
"0","# NLEé¡¹ç›®"
"0","if(exists(""nle_affected_metrics"")) {"
"0","  nle_results <- run_gentrification_analysis("
"0","    nle_affected_metrics, 2015, ""NLE"","
"0","    if(exists(""nine_elms_station"")) nine_elms_station else NULL"
"0","  )"
"0","}"
"1","
========== NLE ç»…å£«åŒ–åˆ†æ ==========
"
"1","
=== åŠ¨æ€ç»…å£«åŒ–æŒ‡æ•° - NLE ===
"
"1","å…¬å¼: åŠ¨æ€æŒ‡æ•° = åŸºäºæ•°æ®è‡ªç„¶åˆ†å¸ƒçš„åŠ æƒåˆæˆ
"
"1","æŒ‡æ•°èŒƒå›´: æ ¹æ®å®é™…æ•°æ®åˆ†å¸ƒç¡®å®šï¼Œæ— äººä¸ºçº¦æŸ
"
"1","
=== æ•°æ®è¯Šæ–­ ===
"
"1","æ•°æ®å¹´ä»½èŒƒå›´:"
"1"," "
"1","2011"
"1"," "
"1","åˆ°"
"1"," "
"1","2022"
"1"," "
"1","
"
"1","åŸºçº¿å¹´ä»½:"
"1"," "
"1","2014"
"1"," "
"1","
"
"1","åˆ†æå¹´ä»½:"
"1"," "
"1","2022"
"1"," "
"1","
"
"1","æ€»æ•°æ®è¡Œæ•°:"
"1"," "
"1","420"
"1"," "
"1","
"
"1","å”¯ä¸€LSOAæ•°é‡:"
"1"," "
"1","35"
"1"," "
"1","
"
"1","åŸºçº¿å¹´LSOAæ•°é‡:"
"1"," "
"1","35"
"1"," "
"1","
"
"1","æœ€æ–°å¹´LSOAæ•°é‡:"
"1"," "
"1","35"
"1"," "
"1","
"
"1","ä¸¤å¹´éƒ½æœ‰æ•°æ®çš„LSOA:"
"1"," "
"1","35"
"1"," "
"1","
"
"1","
=== çŠ¯ç½ªç‡æ•°æ®æ£€æŸ¥ ===
"
