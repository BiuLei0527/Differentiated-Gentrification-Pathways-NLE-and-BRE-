"0","check_parallel_trends <- function(matched_data, project_type) {"
"0","  "
"0","  if(project_type == ""NLE"") {"
"0","    "
"0","    trends <- matched_data %>%"
"0","      group_by(treatment) %>%"
"0","      summarise("
"0","        # PTAL Trend（2005, 2007, 2010, 2012, 2014）"
"0","        ptal_2005_mean = mean(PTAL_Value_2005, na.rm = TRUE),"
"0","        ptal_2007_mean = mean(PTAL_Value_2007, na.rm = TRUE),"
"0","        ptal_2010_mean = mean(PTAL_Value_2010, na.rm = TRUE),"
"0","        ptal_2012_mean = mean(PTAL_Value_2012, na.rm = TRUE),"
"0","        ptal_2014_mean = mean(PTAL_Value_2014, na.rm = TRUE),"
"0","        "
"0","        # IMD Trend（2004, 2007, 2010）"
"0","        imd_2004_mean = mean(imd2004, na.rm = TRUE),"
"0","        imd_2007_mean = mean(imd2007, na.rm = TRUE),"
"0","        imd_2010_mean = mean(imd2010, na.rm = TRUE),"
"0","        "
"0","        # Population Trend（2011-2014）"
"0","        pop_2011_mean = mean(population_2011, na.rm = TRUE),"
"0","        pop_2012_mean = mean(population_2012, na.rm = TRUE),"
"0","        pop_2013_mean = mean(population_2013, na.rm = TRUE),"
"0","        pop_2014_mean = mean(population_2014, na.rm = TRUE),"
"0","        .groups = ""drop"")"
"0","    "
"0","    ptal_trend_diff_long = (trends$ptal_2014_mean[trends$treatment==1] - "
"0","                            trends$ptal_2007_mean[trends$treatment==1]) - "
"0","                           (trends$ptal_2014_mean[trends$treatment==0] - "
"0","                            trends$ptal_2007_mean[trends$treatment==0])"
"0","    "
"0","    imd_trend_diff_long = (trends$imd_2010_mean[trends$treatment==1] - "
"0","                           trends$imd_2004_mean[trends$treatment==1]) - "
"0","                          (trends$imd_2010_mean[trends$treatment==0] - "
"0","                           trends$imd_2004_mean[trends$treatment==0])"
"0","    "
"0","  } else if(project_type == ""BRE"") {"
"0","    trends <- matched_data %>%"
"0","      group_by(treatment) %>%"
"0","      summarise("
"0","        # PTAL Trend（2005, 2007, 2010, 2012, 2014, 2015）"
"0","        ptal_2005_mean = mean(PTAL_Value_2005, na.rm = TRUE),"
"0","        ptal_2007_mean = mean(PTAL_Value_2007, na.rm = TRUE),"
"0","        ptal_2010_mean = mean(PTAL_Value_2010, na.rm = TRUE),"
"0","        ptal_2012_mean = mean(PTAL_Value_2012, na.rm = TRUE),"
"0","        ptal_2014_mean = mean(PTAL_Value_2014, na.rm = TRUE),"
"0","        ptal_2015_mean = mean(PTAL_Value_2015, na.rm = TRUE),"
"0","        "
"0","        # IMD Trend（2004, 2007, 2010, 2015）"
"0","        imd_2004_mean = mean(imd2004, na.rm = TRUE),"
"0","        imd_2007_mean = mean(imd2007, na.rm = TRUE),"
"0","        imd_2010_mean = mean(imd2010, na.rm = TRUE),"
"0","        imd_2015_mean = mean(imd2015, na.rm = TRUE),"
"0","        "
"0","        # Population Trend（2011-2015）"
"0","        pop_2011_mean = mean(population_2011, na.rm = TRUE),"
"0","        pop_2012_mean = mean(population_2012, na.rm = TRUE),"
"0","        pop_2013_mean = mean(population_2013, na.rm = TRUE),"
"0","        pop_2014_mean = mean(population_2014, na.rm = TRUE),"
"0","        pop_2015_mean = mean(population_2015, na.rm = TRUE),"
"0","        .groups = ""drop"")"
"0","    "
"0","    ptal_trend_diff_long = (trends$ptal_2015_mean[trends$treatment==1] - "
"0","                           trends$ptal_2007_mean[trends$treatment==1]) - "
"0","                          (trends$ptal_2015_mean[trends$treatment==0] - "
"0","                           trends$ptal_2007_mean[trends$treatment==0])"
"0","    "
"0","    imd_trend_diff_long = (trends$imd_2015_mean[trends$treatment==1] - "
"0","                          trends$imd_2004_mean[trends$treatment==1]) - "
"0","                         (trends$imd_2015_mean[trends$treatment==0] - "
"0","                          trends$imd_2004_mean[trends$treatment==0]) }"
"0","  "
"0","  cat(""\nParallel Trends Test Results:\n"")"
"0","  cat(""=====================================\n"")"
"0","  cat(""PTAL long-term trend difference:"", round(ptal_trend_diff_long, 3), ""\n"")"
"0","  cat(""IMD long-term trend difference:"", round(imd_trend_diff_long, 3), ""\n"")"
"0","  "
"0","  ptal_pass <- abs(ptal_trend_diff_long) < 0.5"
"0","  imd_pass <- abs(imd_trend_diff_long) < 5"
"0",""
"0","  ptal_marginal <- abs(ptal_trend_diff_long) >= 0.5 & abs(ptal_trend_diff_long) < 1"
"0","  imd_marginal <- abs(imd_trend_diff_long) >= 5 & abs(imd_trend_diff_long) < 10"
"0","  "
"0","  if(ptal_pass & imd_pass) {"
"0","    cat(""✓ Parallel trends assumption satisfied\n"")"
"0","    parallel_satisfied <- TRUE} else if(ptal_marginal || imd_marginal) {"
"0","    cat(""⚠ Parallel trends marginally violated\n"")"
"0","    cat(""  Interpretation: Results should be interpreted with caution\n"")"
"0","    "
"0","    if(!ptal_pass) {"
"0","      cat(""  - PTAL trend difference:"", round(ptal_trend_diff_long, 3), "
"0","          ""(threshold: 0.5)\n"")}"
"0","    if(!imd_pass) {"
"0","      cat(""  - IMD trend difference:"", round(imd_trend_diff_long, 3), "
"0","          ""(threshold: 5)\n"")}"
"0","    "
"0","    cat(""\nRecommendations:\n"")"
"0","    cat(""  1. Include pre-treatment trends as controls in DID\n"")"
"0","    cat(""  2. Consider using event study specification\n"")"
"0","    cat(""  3. Report results with appropriate caveats\n"")"
"0","    "
"0","    parallel_satisfied <- FALSE} else {"
"0","    cat(""✗ Parallel trends assumption violated\n"")"
"0","    cat(""  Consider alternative identification strategies\n"")"
"0","    parallel_satisfied <- FALSE}"
"0",""
"0","if(abs(ptal_trend_diff_long) < 0.5 & abs(imd_trend_diff_long) < 5) {"
"0","  cat(""✓ Parallel trends assumption satisfied\n"")"
"0","  parallel_satisfied <- TRUE} else {"
"0","  cat(""⚠️ Parallel trends assumption may not be satisfied\n"")"
"0","  parallel_satisfied <- FALSE}"
"0",""
"0","plot_trends(trends, project_type)"
"0",""
"0","return(list(trends = trends,"
"0","  ptal_diff = ptal_trend_diff_long,"
"0","  imd_diff = imd_trend_diff_long,"
"0","  parallel_satisfied = parallel_satisfied))}"
"0",""
"0","plot_trends <- function(trends, project_type) {"
"0","  "
"0","  library(ggplot2)"
"0","  library(tidyr)"
"0","  library(scales)"
"0","  library(patchwork)"
"0","  "
"0","  select <- dplyr::select"
"0","  "
"0","  theme_academic <- theme_bw() +"
"0","    theme(plot.title = element_text(size = 14, face = ""bold"", hjust = 0.5),"
"0","      plot.subtitle = element_text(size = 11, hjust = 0.5, color = ""gray30""),"
"0","      axis.title = element_text(size = 11, face = ""bold""),"
"0","      axis.text = element_text(size = 10),"
"0","     "
"0","      legend.title = element_text(size = 10, face = ""bold""),"
"0","      legend.text = element_text(size = 9),"
"0","      legend.position = ""bottom"","
"0","      legend.background = element_rect(fill = ""white"", color = ""gray80""),"
"0","  "
"0","      panel.grid.major = element_line(color = ""gray90"", size = 0.3),"
"0","      panel.grid.minor = element_blank(),"
"0","      panel.border = element_rect(color = ""gray20"", size = 1),"
"0","   "
"0","      plot.background = element_rect(fill = ""white""),"
"0","      panel.background = element_rect(fill = ""white""))"
"0",""
"0","  academic_colors <- c(""Treatment"" = ""#D62728"","
"0","    ""Control"" = ""#1F77B4"" )"
"0",""
"0","  intervention_year <- ifelse(project_type == ""NLE"", 2015, 2016)"
"0","  "
"0","  "
"0","  ptal_long <- trends %>%"
"0","    select(treatment, starts_with(""ptal_"")) %>%"
"0","    pivot_longer("
"0","      cols = starts_with(""ptal_""),"
"0","      names_to = ""year"","
"0","      values_to = ""ptal"") %>%"
"0","    mutate( year = as.numeric(str_extract(year, ""\\d{4}"")),"
"0","      Group = factor(ifelse(treatment == 1, ""Treatment"", ""Control""),"
"0","                    levels = c(""Treatment"", ""Control""))) %>%"
"0","    filter(!is.na(ptal))"
"0",""
"0","  ptal_summary <- ptal_long %>%"
"0","    group_by(year, Group) %>%"
"0","    summarise("
"0","      mean_ptal = mean(ptal, na.rm = TRUE),"
"0","      se_ptal = sd(ptal, na.rm = TRUE) / sqrt(n()),"
"0","      .groups = ""drop"")"
"0","  "
"0","  p_ptal <- ggplot(ptal_summary, aes(x = year, y = mean_ptal, color = Group)) +"
"0",""
"0","    geom_ribbon(aes(ymin = mean_ptal - 1.96*se_ptal, "
"0","                   ymax = mean_ptal + 1.96*se_ptal,"
"0","                   fill = Group),"
"0","               alpha = 0.15, color = NA) +"
"0",""
"0","    geom_line(size = 1.2) +"
"0",""
"0","    geom_point(size = 3, shape = 19) +"
"0",""
"0","    geom_vline(xintercept = intervention_year - 0.5,"
"0","               linetype = ""dashed"", "
"0","               color = ""gray40"", "
"0","               size = 0.8,"
"0","               alpha = 0.8) +"
"0",""
"0","    annotate(""text"", "
"0","            x = intervention_year - 0.5, "
"0","            y = max(ptal_summary$mean_ptal) * 0.95,"
"0","            label = paste(project_type, ""Intervention""),"
"0","            angle = 90, "
"0","            vjust = -0.5,"
"0","            size = 3.5,"
"0","            color = ""gray40"") +"
"0",""
"0","    labs(title = paste0(""Figure 1: Pre-treatment PTAL Trends - "", project_type),"
"0","      subtitle = ""Public Transport Accessibility Level (2005-2015)"","
"0","      x = ""Year"","
"0","      y = ""Mean PTAL Score"","
"0","      color = ""Group"","
"0","      fill = ""Group"") +"
"0",""
"0","    scale_color_manual(values = academic_colors) +"
"0","    scale_fill_manual(values = academic_colors) +"
"0",""
"0","    scale_x_continuous(breaks = seq(2005, 2015, by = 2),"
"0","      limits = c(2004.5, max(ptal_summary$year) + 0.5)) +"
"0","    "
"0","    scale_y_continuous(labels = number_format(accuracy = 0.1)) +"
"0",""
"0","    theme_academic"
"0","  "
"0","  imd_long <- trends %>%"
"0","    select(treatment, starts_with(""imd_"")) %>%"
"0","    pivot_longer(cols = starts_with(""imd_""),"
"0","      names_to = ""year"","
"0","      values_to = ""imd"") %>%"
"0","    mutate(year = as.numeric(str_extract(year, ""\\d{4}"")),"
"0","      Group = factor(ifelse(treatment == 1, ""Treatment"", ""Control""),"
"0","                    levels = c(""Treatment"", ""Control""))) %>%"
"0","    filter(!is.na(imd))"
"0","  "
"0","  imd_summary <- imd_long %>%"
"0","    group_by(year, Group) %>%"
"0","    summarise("
"0","      mean_imd = mean(imd, na.rm = TRUE),"
"0","      se_imd = sd(imd, na.rm = TRUE) / sqrt(n()),"
"0","      .groups = ""drop"")"
"0","  "
"0","  p_imd <- ggplot(imd_summary, aes(x = year, y = mean_imd, color = Group)) +"
"0","    geom_ribbon(aes(ymin = mean_imd - 1.96*se_imd, "
"0","                   ymax = mean_imd + 1.96*se_imd,"
"0","                   fill = Group),"
"0","               alpha = 0.15, color = NA) +"
"0","    geom_line(size = 1.2) +"
"0","    geom_point(size = 3, shape = 19) +"
"0","    geom_vline(xintercept = intervention_year - 0.5,"
"0","               linetype = ""dashed"", "
"0","               color = ""gray40"", "
"0","               size = 0.8,"
"0","               alpha = 0.8) +"
"0","    annotate(""text"", "
"0","            x = intervention_year - 0.5, "
"0","            y = max(imd_summary$mean_imd) * 0.95,"
"0","            label = paste(project_type, ""Intervention""),"
"0","            angle = 90, "
"0","            vjust = -0.5,"
"0","            size = 3.5,"
"0","            color = ""gray40"") +"
"0","    labs(title = paste0(""Figure 2: Pre-treatment IMD Trends - "", project_type),"
"0","      subtitle = ""Index of Multiple Deprivation (2004-2015)"","
"0","      x = ""Year"","
"0","      y = ""Mean IMD Score"","
"0","      color = ""Group"","
"0","      fill = ""Group"") +"
"0","    scale_color_manual(values = academic_colors) +"
"0","    scale_fill_manual(values = academic_colors) +"
"0","    scale_x_continuous("
"0","      breaks = seq(2004, 2015, by = 2),"
"0","      limits = c(2003.5, max(imd_summary$year) + 0.5)) +"
"0","    scale_y_continuous(labels = number_format(accuracy = 0.1)) +"
"0","    theme_academic"
"0","  "
"0","  pop_long <- trends %>%"
"0","    select(treatment, starts_with(""pop_"")) %>%"
"0","    pivot_longer(cols = starts_with(""pop_""),"
"0","      names_to = ""year"","
"0","      values_to = ""population"") %>%"
"0","    mutate(year = as.numeric(str_extract(year, ""\\d{4}"")),"
"0","      Group = factor(ifelse(treatment == 1, ""Treatment"", ""Control""),"
"0","                    levels = c(""Treatment"", ""Control""))) %>%"
"0","    filter(!is.na(population))"
"0","  "
"0","  pop_summary <- pop_long %>%"
"0","    group_by(year, Group) %>%"
"0","    summarise(mean_pop = mean(population, na.rm = TRUE),"
"0","      se_pop = sd(population, na.rm = TRUE) / sqrt(n()),"
"0","      .groups = ""drop"")"
"0","  "
"0","  p_pop <- ggplot(pop_summary, aes(x = year, y = mean_pop, color = Group)) +"
"0","    geom_ribbon(aes(ymin = mean_pop - 1.96*se_pop, "
"0","                   ymax = mean_pop + 1.96*se_pop,"
"0","                   fill = Group),"
"0","               alpha = 0.15, color = NA) +"
"0","    geom_line(size = 1.2) +"
"0","    geom_point(size = 3, shape = 19) +"
"0","    geom_vline(xintercept = intervention_year - 0.5,"
"0","               linetype = ""dashed"", "
"0","               color = ""gray40"", "
"0","               size = 0.8,"
"0","               alpha = 0.8) +"
"0","    annotate(""text"", "
"0","            x = intervention_year - 0.5, "
"0","            y = max(pop_summary$mean_pop) * 0.95,"
"0","            label = paste(project_type, ""Intervention""),"
"0","            angle = 90, "
"0","            vjust = -0.5,"
"0","            size = 3.5,"
"0","            color = ""gray40"") +"
"0","    labs(title = paste0(""Figure 3: Pre-treatment Population Trends - "", project_type),"
"0","      subtitle = ""Average LSOA Population (2011-2015)"","
"0","      x = ""Year"","
"0","      y = ""Mean Population"","
"0","      color = ""Group"","
"0","      fill = ""Group"") +"
"0","    scale_color_manual(values = academic_colors) +"
"0","    scale_fill_manual(values = academic_colors) +"
"0","    scale_x_continuous(breaks = seq(2011, 2015, by = 1),"
"0","      limits = c(2010.5, max(pop_summary$year) + 0.5)) +"
"0","    scale_y_continuous(labels = comma_format()) + theme_academic"
"0","  "
"0","  combined_plot <- (p_ptal / p_imd / p_pop) +"
"0","    plot_layout(guides = ""collect"") +"
"0","    plot_annotation("
"0","      title = paste(""Parallel Trends Test:"", project_type, ""Extension""),"
"0","      subtitle = ""Comparison of Treatment and Control Groups Before Intervention"","
"0","      caption = ""Note: Shaded areas represent 95% confidence intervals. Vertical dashed line indicates intervention timing."","
"0","      theme = theme("
"0","        plot.title = element_text(size = 16, face = ""bold"", hjust = 0.5),"
"0","        plot.subtitle = element_text(size = 12, hjust = 0.5, color = ""gray30""),"
"0","        plot.caption = element_text(size = 9, hjust = 0, color = ""gray40"", "
"0","                                   margin = margin(t = 10))))"
"0","  "
"0","  if(!dir.exists(""figures"")) dir.create(""figures"")"
"0","  "
"0","  ggsave(filename = paste0(""figures/"", tolower(project_type), ""_ptal_trends.png""),"
"0","    plot = p_ptal,"
"0","    width = 10,"
"0","    height = 6,"
"0","    dpi = 300,"
"0","    bg = ""white"")"
"0","  "
"0","  ggsave(filename = paste0(""figures/"", tolower(project_type), ""_imd_trends.png""),"
"0","    plot = p_imd,"
"0","    width = 10,"
"0","    height = 6,"
"0","    dpi = 300,"
"0","    bg = ""white"")"
"0","  "
"0","  ggsave(filename = paste0(""figures/"", tolower(project_type), ""_pop_trends.png""),"
"0","    plot = p_pop,"
"0","    width = 10,"
"0","    height = 6,"
"0","    dpi = 300,"
"0","    bg = ""white"")"
"0","  "
"0","  ggsave(filename = paste0(""figures/"", tolower(project_type), ""_parallel_trends_combined.png""),"
"0","    plot = combined_plot,"
"0","    width = 12,"
"0","    height = 14,"
"0","    dpi = 300,"
"0","    bg = ""white"")"
"0","  "
"0","  ggsave(filename = paste0(""figures/"", tolower(project_type), ""_parallel_trends_combined.pdf""),"
"0","    plot = combined_plot,"
"0","    width = 12,"
"0","    height = 14,"
"0","    device = cairo_pdf,"
"0","    bg = ""white"")"
"0","  "
"0",""
"0","  print(combined_plot)"
"0","  "
"0","  cat(""\nFigures saved to 'figures/' directory:\n"")"
"0","  cat(""- PNG files (300 dpi) for presentations\n"")"
"0","  cat(""- PDF file for academic publication\n"")"
"0","  "
"0","  return(invisible(list("
"0","    ptal = p_ptal,"
"0","    imd = p_imd,"
"0","    population = p_pop,"
"0","    combined = combined_plot)))}"
"0",""
