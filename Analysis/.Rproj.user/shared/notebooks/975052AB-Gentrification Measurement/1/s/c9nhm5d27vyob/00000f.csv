"0","library(tidyverse)"
"0","library(MatchIt)"
"0",""
"0","select_controls_improved <- function(all_lsoa, treatment_lsoas,"
"0","                                    project_type, dist_to_station) {"
"0","  "
"0","  if(project_type == ""NLE"") {"
"0","    baseline_data <- all_lsoa %>%"
"0","      mutate(treatment = ifelse(LSOA11CD %in% treatment_lsoas, 1, 0),"
"0","        dist = dist_to_station,"
"0","        "
"0","        ptal_baseline = PTAL_Value_2014,"
"0","        imd_baseline = imd2010,"
"0","        pop_baseline = population_2014,"
"0","        "
"0","        ptal_trend_short = (PTAL_Value_2014 - PTAL_Value_2012)/2,"
"0","        pop_trend_short = (population_2014 - population_2012)/2,"
"0","        "
"0","        ptal_trend_long = (PTAL_Value_2014 - PTAL_Value_2007)/7,"
"0","        imd_trend_long = (imd2010 - imd2004)/6,"
"0","        pop_trend_long = (population_2014 - population_2011)/3)"
"0","    "
"0","  } else if(project_type == ""BRE"") {"
"0","    baseline_data <- all_lsoa %>%"
"0","      mutate(treatment = ifelse(LSOA11CD %in% treatment_lsoas, 1, 0),"
"0","        dist = dist_to_station,"
"0","        "
"0","        ptal_baseline = PTAL_Value_2015,"
"0","        imd_baseline = imd2015,"
"0","        pop_baseline = population_2015,"
"0","        "
"0","        ptal_trend_short = (PTAL_Value_2015 - PTAL_Value_2014)/1,"
"0","        imd_trend_short = (imd2015 - imd2010)/5,"
"0","        "
"0","        ptal_trend_long = (PTAL_Value_2015 - PTAL_Value_2007)/8,"
"0","        imd_trend_long = (imd2015 - imd2004)/11,"
"0","        pop_trend_long = (population_2015 - population_2011)/4)}"
"0",""
"0","  required_cols <- c("
"0","    ""PTAL_Value_2005"", ""PTAL_Value_2007"", ""PTAL_Value_2010"", "
"0","    ""PTAL_Value_2012"", ""PTAL_Value_2014"", ""PTAL_Value_2015"","
"0","    "
"0","    ""imd2004"", ""imd2007"", ""imd2010"", ""imd2015"","
"0","    "
"0","    ""population_2011"", ""population_2012"", ""population_2013"", "
"0","    ""population_2014"", ""population_2015"")"
"0","  "
"0","  existing_cols <- intersect(required_cols, names(baseline_data))"
"0","  missing_cols <- setdiff(required_cols, names(baseline_data))"
"0","  "
"0","  if(length(missing_cols) > 0) {"
"0","    cat(""Warning: Missing columns:"", paste(missing_cols, collapse="", ""), ""\n"")}"
"0",""
"0","  potential_controls <- baseline_data %>%"
"0","    filter(treatment == 0,"
"0","      dist >= 2000 & dist <= 5000,"
"0","      !is.na(ptal_baseline),"
"0","      !is.na(imd_baseline),"
"0","      !is.na(pop_baseline),"
"0","      !is.na(ptal_trend_long),"
"0","      !is.na(imd_trend_long))"
"0","  "
"0","  cat(""Number of potential controls:"", nrow(potential_controls), ""\n"")"
"0","  "
"0","  psm_match <- matchit("
"0","    treatment ~ ptal_baseline + imd_baseline + log(pop_baseline + 1) +"
"0","                ptal_trend_long + imd_trend_long + pop_trend_long,"
"0","    data = bind_rows("
"0","      baseline_data %>% filter(treatment == 1),"
"0","      potential_controls),"
"0","    method = ""nearest"","
"0","    distance = ""logit"","
"0","    ratio = ifelse(sum(baseline_data$treatment == 1) <= 3, 10,"
"0","                   ifelse(sum(baseline_data$treatment == 1) <= 10, 5, 3)),"
"0","    caliper = 0.2,"
"0","    replace = FALSE)"
"0","  "
"0","  matched_data <- match.data(psm_match)"
"0","  "
"0","  cat(project_type, ""Matching:\n"")"
"0","  cat(""- Treatment group:"", sum(matched_data$treatment == 1), ""LSOA\n"")"
"0","  cat(""- Control group:"", sum(matched_data$treatment == 0), ""LSOA\n"")"
"0","  cat(""- Actual ratio: 1:"","
"0","      round(sum(matched_data$treatment == 0) / sum(matched_data$treatment == 1), 1), ""\n\n"")"
"0",""
"0","  return(matched_data)}"
