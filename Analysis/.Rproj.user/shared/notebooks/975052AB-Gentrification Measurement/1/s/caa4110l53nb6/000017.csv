"0","# ============================================="
"0","# 主执行流程 - 完整版（含质量检查和改进）"
"0","# ============================================="
"0",""
"0","# Step 1: 准备数据"
"0","cat(""========================================\n"")"
"1","========================================
"
"0","cat(""Starting Control Group Selection Analysis\n"")"
"1","Starting Control Group Selection Analysis
"
"0","cat(""========================================\n\n"")"
"1","========================================

"
"0","data <- prepare_did_data()"
"1","Data validation:
"
"1","- Total LSOAs:"
"1"," "
"1","4835"
"1"," "
"1","
"
"1","- NLE treatment group:"
"1"," "
"1","12"
"1"," "
"1","LSOAs
"
"1","- BRE treatment group:"
"1"," "
"1","2"
"1"," "
"1","LSOAs
"
"1","- PTAL 2014 missing:"
"1"," "
"1","0"
"1"," "
"1","
"
"1","- IMD 2010 missing:"
"1"," "
"1","0"
"1"," "
"1","
"
"1","- Population 2014 missing:"
"1"," "
"1","0"
"1"," "
"1","
"
"0","# Step 2: NLE控制组选择（标准流程）"
"0","cat(""\n--- NLE Control Group Selection ---\n"")"
"1","
--- NLE Control Group Selection ---
"
"0","nle_matched <- select_controls_improved("
"0","  all_lsoa = data$all_lsoa,"
"0","  treatment_lsoas = data$nle_lsoas,"
"0","  project_type = ""NLE"","
"0","  dist_to_station = data$all_lsoa$dist_to_nle_station"
"0",")"
"1","Number of potential controls:"
"1"," "
"1","413"
"1"," "
"1","
"
"1","NLE"
"1"," "
"1","Matching:
"
"1","- Treatment group:"
"1"," "
"1","12"
"1"," "
"1","LSOA
"
"1","- Control group:"
"1"," "
"1","32"
"1"," "
"1","LSOA
"
"1","- Actual ratio: 1:"
"1"," "
"1","2.7"
"1"," "
"1","

"
"0","# Step 3: BRE控制组选择（智能适应+质量控制版本）"
"0","cat(""\n--- BRE Control Group Selection ---\n"")"
"1","
--- BRE Control Group Selection ---
"
"0","n_bre_treated <- length(data$bre_lsoas)"
"0","cat(""BRE treatment group size:"", n_bre_treated, ""LSOA(s)\n"")"
"1","BRE treatment group size:"
"1"," "
"1","2"
"1"," "
"1","LSOA(s)
"
"0","if(n_bre_treated <= 3) {"
"0","  # 小样本：先尝试PSM，失败再用直接匹配"
"0","  cat(""Small sample detected - will attempt PSM first\n\n"")"
"0","  "
"0","  # 准备BRE数据"
"0","  bre_baseline <- data$all_lsoa %>%"
"0","    mutate("
"0","      treatment = ifelse(LSOA11CD %in% data$bre_lsoas, 1, 0),"
"0","      dist = dist_to_bre_station,"
"0","      ptal_baseline = PTAL_Value_2015,"
"0","      imd_baseline = imd2015,"
"0","      pop_baseline = population_2015,"
"0","      "
"0","      # 添加趋势变量"
"0","      ptal_trend = ifelse(!is.na(PTAL_Value_2015) & !is.na(PTAL_Value_2014),"
"0","                         PTAL_Value_2015 - PTAL_Value_2014, NA),"
"0","      imd_trend = ifelse(!is.na(imd2015) & !is.na(imd2010),"
"0","                        (imd2015 - imd2010)/5, NA)"
"0","    )"
"0","  "
"0","  # 获取处理组特征"
"0","  treatment_info <- bre_baseline %>%"
"0","    filter(treatment == 1) %>%"
"0","    summarise("
"0","      mean_ptal = mean(ptal_baseline, na.rm = TRUE),"
"0","      mean_imd = mean(imd_baseline, na.rm = TRUE),"
"0","      mean_pop = mean(pop_baseline, na.rm = TRUE),"
"0","      sd_ptal = sd(ptal_baseline, na.rm = TRUE),"
"0","      sd_imd = sd(imd_baseline, na.rm = TRUE)"
"0","    )"
"0","  "
"0","  cat(""Treatment group characteristics:\n"")"
"0","  cat(""  PTAL: Mean ="", round(treatment_info$mean_ptal, 2), "
"0","      ""SD ="", round(treatment_info$sd_ptal, 2), ""\n"")"
"0","  cat(""  IMD: Mean ="", round(treatment_info$mean_imd, 2),"
"0","      ""SD ="", round(treatment_info$sd_imd, 2), ""\n"")"
"0","  cat(""  Population: Mean ="", round(treatment_info$mean_pop, 0), ""\n\n"")"
"0","  "
"0","  # 初始搜索范围"
"0","  search_radius <- c(2000, 8000)"
"0","  "
"0","  # 筛选潜在控制组"
"0","  bre_potential <- bre_baseline %>%"
"0","    filter("
"0","      treatment == 0,"
"0","      dist >= search_radius[1] & dist <= search_radius[2],"
"0","      !is.na(ptal_baseline),"
"0","      !is.na(imd_baseline),"
"0","      !is.na(pop_baseline)"
"0","    )"
"0","  "
"0","  cat(""Searching in"", search_radius[1]/1000, ""-"", search_radius[2]/1000, ""km range\n"")"
"0","  cat(""Potential controls found:"", nrow(bre_potential), ""LSOAs\n"")"
"0","  "
"0","  # 如果潜在控制组太少，扩大范围"
"0","  min_controls_needed <- n_bre_treated * 20"
"0","  "
"0","  if(nrow(bre_potential) < min_controls_needed) {"
"0","    cat(""Expanding search to 2-10km for more options...\n"")"
"0","    search_radius[2] <- 10000"
"0","    "
"0","    bre_potential <- bre_baseline %>%"
"0","      filter("
"0","        treatment == 0,"
"0","        dist >= search_radius[1] & dist <= search_radius[2],"
"0","        !is.na(ptal_baseline),"
"0","        !is.na(imd_baseline),"
"0","        !is.na(pop_baseline)"
"0","      )"
"0","    cat(""Extended search found:"", nrow(bre_potential), ""LSOAs\n"")"
"0","  }"
"0","  "
"0","  # ========== PSM尝试阶段 =========="
"0","  cat(""\n--- Attempting Propensity Score Matching ---\n"")"
"0","  "
"0","  psm_success <- FALSE"
"0","  bre_matched <- NULL"
"0","  "
"0","  # 定义不同复杂度的模型"
"0","  model_specs <- list("
"0","    full = list("
"0","      formula = treatment ~ ptal_baseline + imd_baseline + log(pop_baseline + 1),"
"0","      name = ""Full model (PTAL + IMD + Population)"""
"0","    ),"
"0","    reduced = list("
"0","      formula = treatment ~ ptal_baseline + imd_baseline,"
"0","      name = ""Reduced model (PTAL + IMD)"""
"0","    ),"
"0","    minimal = list("
"0","      formula = treatment ~ ptal_baseline,"
"0","      name = ""Minimal model (PTAL only)"""
"0","    )"
"0","  )"
"0","  "
"0","  # 根据样本大小设置匹配参数"
"0","  if(n_bre_treated == 1) {"
"0","    match_ratio <- 10"
"0","    caliper_val <- 0.5"
"0","    replace_val <- TRUE"
"0","    cat(""Matching parameters: ratio=1:10, caliper=0.5, replace=TRUE\n"")"
"0","  } else if(n_bre_treated == 2) {"
"0","    match_ratio <- 5"
"0","    caliper_val <- 0.3"
"0","    replace_val <- TRUE"
"0","    cat(""Matching parameters: ratio=1:5, caliper=0.3, replace=TRUE\n"")"
"0","  } else {"
"0","    match_ratio <- 4"
"0","    caliper_val <- 0.25"
"0","    replace_val <- FALSE"
"0","    cat(""Matching parameters: ratio=1:4, caliper=0.25, replace=FALSE\n"")"
"0","  }"
"0","  "
"0","  # 逐个尝试模型"
"0","  for(model_id in names(model_specs)) {"
"0","    cat(""\nTrying:"", model_specs[[model_id]]$name, ""\n"")"
"0","    "
"0","    psm_result <- tryCatch({"
"0","      "
"0","      # 准备数据池"
"0","      bre_pool <- bind_rows("
"0","        bre_baseline %>% filter(treatment == 1),"
"0","        bre_potential"
"0","      )"
"0","      "
"0","      # 执行匹配"
"0","      bre_match <- matchit("
"0","        model_specs[[model_id]]$formula,"
"0","        data = bre_pool,"
"0","        method = ""nearest"","
"0","        distance = ""logit"","
"0","        ratio = match_ratio,"
"0","        caliper = caliper_val,"
"0","        replace = replace_val"
"0","      )"
"0","      "
"0","      # 提取匹配数据"
"0","      matched_temp <- match.data(bre_match)"
"0","      n_matched_controls <- sum(matched_temp$treatment == 0)"
"0","      "
"0","      # 检查是否成功匹配到足够的控制组"
"0","      if(n_matched_controls >= n_bre_treated) {"
"0","        cat(""  ✓ SUCCESS: Matched"", n_matched_controls, ""controls\n"")"
"0","        "
"0","        # 计算匹配质量"
"0","        balance_stats <- matched_temp %>%"
"0","          group_by(treatment) %>%"
"0","          summarise("
"0","            mean_ptal = mean(ptal_baseline, na.rm = TRUE),"
"0","            mean_imd = mean(imd_baseline, na.rm = TRUE),"
"0","            .groups = ""drop"""
"0","          )"
"0","        "
"0","        smd_ptal <- abs(diff(balance_stats$mean_ptal)) / "
"0","                    sd(matched_temp$ptal_baseline, na.rm = TRUE)"
"0","        smd_imd <- abs(diff(balance_stats$mean_imd)) / "
"0","                   sd(matched_temp$imd_baseline, na.rm = TRUE)"
"0","        "
"0","        cat(""  Balance: SMD_PTAL ="", round(smd_ptal, 3), "
"0","            ""SMD_IMD ="", round(smd_imd, 3), ""\n"")"
"0","        "
"0","        list(success = TRUE, data = matched_temp, "
"0","             smd_ptal = smd_ptal, smd_imd = smd_imd, model = model_id)"
"0","      } else {"
"0","        cat(""  ✗ Insufficient matches (only"", n_matched_controls, ""controls)\n"")"
"0","        list(success = FALSE)"
"0","      }"
"0","      "
"0","    }, error = function(e) {"
"0","      error_msg <- substr(gsub(""\n"", "" "", e$message), 1, 60)"
"0","      cat(""  ✗ Error:"", error_msg, ""...\n"")"
"0","      list(success = FALSE)"
"0","    })"
"0","    "
"0","    # 如果成功，保存结果"
"0","    if(psm_result$success) {"
"0","      bre_matched <- psm_result$data"
"0","      psm_success <- TRUE"
"0","      psm_smd_ptal <- psm_result$smd_ptal"
"0","      psm_smd_imd <- psm_result$smd_imd"
"0","      cat(""\nPSM successful with"", model_id, ""model\n"")"
"0","      break"
"0","    }"
"0","  }"
"0","  "
"0","  # ========== PSM质量检查和改进 =========="
"0","  if(psm_success) {"
"0","    cat(""\n--- Checking PSM Quality ---\n"")"
"0","    cat(""SMD_PTAL ="", round(psm_smd_ptal, 3), ""\n"")"
"0","    cat(""SMD_IMD ="", round(psm_smd_imd, 3), ""\n"")"
"0","    "
"0","    # 判断平衡性"
"0","    if(psm_smd_ptal > 0.25 || psm_smd_imd > 0.25) {"
"0","      cat(""\n⚠ Warning: Poor balance achieved with PSM\n"")"
"0","      "
"0","      # 如果IMD平衡特别差，切换到精确匹配"
"0","      if(psm_smd_imd > 0.5) {"
"0","        cat(""SMD_IMD > 0.5 - Switching to exact matching on IMD...\n"")"
"0","        "
"0","        # 找IMD最接近的控制组"
"0","        bre_potential_exact <- bre_potential %>%"
"0","          mutate("
"0","            imd_diff = abs(imd_baseline - treatment_info$mean_imd),"
"0","            ptal_diff = abs(ptal_baseline - treatment_info$mean_ptal)"
"0","          ) %>%"
"0","          # 先按IMD差异排序，再按PTAL差异"
"0","          arrange(imd_diff, ptal_diff) %>%"
"0","          slice_head(n = n_bre_treated * ifelse(n_bre_treated == 1, 10, 5))"
"0","        "
"0","        bre_matched <- bind_rows("
"0","          bre_baseline %>% filter(treatment == 1),"
"0","          bre_potential_exact %>% mutate(treatment = 0)"
"0","        )"
"0","        "
"0","        # 重新计算SMD"
"0","        balance_stats_new <- bre_matched %>%"
"0","          group_by(treatment) %>%"
"0","          summarise("
"0","            mean_ptal = mean(ptal_baseline, na.rm = TRUE),"
"0","            mean_imd = mean(imd_baseline, na.rm = TRUE),"
"0","            .groups = ""drop"""
"0","          )"
"0","        "
"0","        smd_ptal_new <- abs(diff(balance_stats_new$mean_ptal)) / "
"0","                        sd(bre_matched$ptal_baseline, na.rm = TRUE)"
"0","        smd_imd_new <- abs(diff(balance_stats_new$mean_imd)) / "
"0","                       sd(bre_matched$imd_baseline, na.rm = TRUE)"
"0","        "
"0","        cat(""\nRe-matched using exact IMD matching:\n"")"
"0","        cat(""New SMD_PTAL ="", round(smd_ptal_new, 3), ""\n"")"
"0","        cat(""New SMD_IMD ="", round(smd_imd_new, 3), ""\n"")"
"0","        "
"0","        psm_success <- FALSE  # 标记为使用了精确匹配"
"0","      } else {"
"0","        cat(""Balance is marginal but acceptable\n"")"
"0","        cat(""Recommend interpreting results with caution\n"")"
"0","      }"
"0","    } else {"
"0","      cat(""✓ Good balance achieved (SMD < 0.25)\n"")"
"0","    }"
"0","  }"
"0","  "
"0","  # ========== 如果PSM完全失败，使用直接匹配 =========="
"0","  if(!psm_success && is.null(bre_matched)) {"
"0","    cat(""\n--- PSM failed, using Direct Similarity Matching ---\n"")"
"0","    "
"0","    # 计算综合距离"
"0","    bre_potential <- bre_potential %>%"
"0","      mutate("
"0","        # 标准化差异"
"0","        ptal_diff = abs(ptal_baseline - treatment_info$mean_ptal) / "
"0","                    sd(bre_baseline$ptal_baseline, na.rm = TRUE),"
"0","        imd_diff = abs(imd_baseline - treatment_info$mean_imd) / "
"0","                   sd(bre_baseline$imd_baseline, na.rm = TRUE),"
"0","        pop_diff = abs(log(pop_baseline + 1) - log(treatment_info$mean_pop + 1)) / "
"0","                   sd(log(bre_baseline$pop_baseline + 1), na.rm = TRUE),"
"0","        "
"0","        # 加权总距离"
"0","        total_distance = ptal_diff * 0.4 + imd_diff * 0.4 + pop_diff * 0.2"
"0","      ) %>%"
"0","      arrange(total_distance)"
"0","    "
"0","    # 选择最相似的控制组"
"0","    n_controls_target <- n_bre_treated * ifelse(n_bre_treated == 1, 10, 5)"
"0","    n_controls_selected <- min(n_controls_target, nrow(bre_potential))"
"0","    "
"0","    selected_controls <- bre_potential %>%"
"0","      slice_head(n = n_controls_selected)"
"0","    "
"0","    bre_matched <- bind_rows("
"0","      bre_baseline %>% filter(treatment == 1),"
"0","      selected_controls %>% mutate(treatment = 0)"
"0","    )"
"0","    "
"0","    cat(""Selected"", n_controls_selected, ""most similar controls\n"")"
"0","    cat(""Average distance:"", round(mean(selected_controls$total_distance), 3), ""\n"")"
"0","  }"
"0","  "
"0","  # ========== 最终报告 =========="
"0","  cat(""\n--- BRE Final Matching Summary ---\n"")"
"0","  cat(""Treatment units:"", sum(bre_matched$treatment == 1), ""\n"")"
"0","  cat(""Control units:"", sum(bre_matched$treatment == 0), ""\n"")"
"0","  cat(""Final ratio: 1:"", round(sum(bre_matched$treatment == 0)/sum(bre_matched$treatment == 1), 1), ""\n"")"
"0","  "
"0","  if(n_bre_treated == 1) {"
"0","    cat(""\n⚠ Single treatment unit detected\n"")"
"0","    cat(""Recommendations:\n"")"
"0","    cat(""  1. Consider Synthetic Control Method (see code below)\n"")"
"0","    cat(""  2. Interpret as case study, not causal effect\n"")"
"0","    cat(""  3. Report with appropriate caveats\n"")"
"0","  }"
"0","  "
"0","} else {"
"0","  # BRE样本足够大（>3），使用标准流程"
"0","  cat(""Standard sample size - using regular PSM\n"")"
"0","  bre_matched <- select_controls_improved("
"0","    all_lsoa = data$all_lsoa,"
"0","    treatment_lsoas = data$bre_lsoas,"
"0","    project_type = ""BRE"","
"0","    dist_to_station = data$all_lsoa$dist_to_bre_station"
"0","  )"
"0","}"
"1","Small sample detected - will attempt PSM first

"
"1","Treatment group characteristics:
"
"1","  PTAL: Mean ="
"1"," "
"1","2.8"
"1"," "
"1","SD ="
"1"," "
"1","0.42"
"1"," "
"1","
"
"1","  IMD: Mean ="
"1"," "
"1","32.18"
"1"," "
"1","SD ="
"1"," "
"1","0.76"
"1"," "
"1","
"
"1","  Population: Mean ="
"1"," "
"1","3302"
"1"," "
"1","

"
"1","Searching in"
"1"," "
"1","2"
"1"," "
"1","-"
"1"," "
"1","8"
"1"," "
"1","km range
"
"1","Potential controls found:"
"1"," "
"1","623"
"1"," "
"1","LSOAs
"
"1","
--- Attempting Propensity Score Matching ---
"
"1","Matching parameters: ratio=1:5, caliper=0.3, replace=TRUE
"
"1","
Trying:"
"1"," "
"1","Full model (PTAL + IMD + Population)"
"1"," "
"1","
"
"2","Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred"
"1","  ✓ SUCCESS: Matched"
"1"," "
"1","5"
"1"," "
"1","controls
"
"1","  Balance: SMD_PTAL ="
"1"," "
"1","0.527"
"1"," "
"1","SMD_IMD ="
"1"," "
"1","1.001"
"1"," "
"1","
"
"1","
PSM successful with"
"1"," "
"1","full"
"1"," "
"1","model
"
"1","
--- Checking PSM Quality ---
"
"1","SMD_PTAL ="
"1"," "
"1","0.527"
"1"," "
"1","
"
"1","SMD_IMD ="
"1"," "
"1","1.001"
"1"," "
"1","
"
"1","
⚠ Warning: Poor balance achieved with PSM
"
"1","SMD_IMD > 0.5 - Switching to exact matching on IMD...
"
"1","
Re-matched using exact IMD matching:
"
"1","New SMD_PTAL ="
"1"," "
"1","1.322"
"1"," "
"1","
"
"1","New SMD_IMD ="
"1"," "
"1","0.166"
"1"," "
"1","
"
"1","
--- BRE Final Matching Summary ---
"
"1","Treatment units:"
"1"," "
"1","2"
"1"," "
"1","
"
"1","Control units:"
"1"," "
"1","10"
"1"," "
"1","
"
"1","Final ratio: 1:"
"1"," "
"1","5"
"1"," "
"1","
"
"0","# Step 4: 验证平行趋势"
"0","cat(""\n========================================\n"")"
"1","
========================================
"
"0","cat(""Parallel Trends Testing\n"")"
"1","Parallel Trends Testing
"
"0","cat(""========================================\n"")"
"1","========================================
"
"0","# NLE平行趋势"
"0","nle_trends <- check_parallel_trends(nle_matched, ""NLE"")"
"1","
Parallel Trends Test Results:
"
"1","=====================================
"
"1","PTAL long-term trend difference:"
"1"," "
"1","-0.645"
"1"," "
"1","
"
"1","IMD long-term trend difference:"
"1"," "
"1","-1.111"
"1"," "
"1","
"
"1","⚠ Parallel trends marginally violated
"
"1","  Interpretation: Results should be interpreted with caution
"
"1","  - PTAL trend difference:"
"1"," "
"1","-0.645"
"1"," "
"1","(threshold: 0.5)
"
"1","
Recommendations:
"
"1","  1. Include pre-treatment trends as controls in DID
"
"1","  2. Consider using event study specification
"
"1","  3. Report results with appropriate caveats
"
"1","⚠️ Parallel trends assumption may not be satisfied
"
"1","
Figures saved to 'figures/' directory:
"
"1","- PNG files (300 dpi) for presentations
"
"1","- PDF file for academic publication
"
