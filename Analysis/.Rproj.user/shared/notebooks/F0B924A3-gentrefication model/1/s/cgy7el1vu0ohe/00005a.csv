"0","library(tidyverse)"
"0","library(fixest)"
"0","library(ggplot2)"
"0","library(patchwork)"
"0","library(broom)"
"0","library(sf)"
"0",""
"0","theme_ucl <- function() {"
"0","  theme_bw() +"
"0","    theme(plot.title = element_text(size = 12, face = ""bold"", hjust = 0),"
"0","      plot.subtitle = element_text(size = 10, hjust = 0, color = ""gray30""),"
"0","      axis.title = element_text(size = 10, face = ""bold""),"
"0","      axis.text = element_text(size = 9),"
"0","      legend.title = element_blank(),"
"0","      legend.text = element_text(size = 9),"
"0","      legend.position = ""bottom"","
"0","      legend.background = element_rect(fill = ""white"", color = NA),"
"0","      panel.grid.major = element_line(color = ""gray90"", size = 0.2),"
"0","      panel.grid.minor = element_blank(),"
"0","      panel.border = element_rect(color = ""black"", size = 0.5),"
"0","      strip.background = element_rect(fill = ""gray95"", color = ""black""),"
"0","      strip.text = element_text(size = 10, face = ""bold""))}"
"0",""
"0","prepare_panel_for_analysis <- function(control_df, treatment_df, project_name) {"
"0","  "
"0","  intervention_year <- ifelse(project_name == ""NLE"", 2015, 2016)"
"0","  "
"0","  control_df <- control_df %>%"
"0","    st_drop_geometry() %>%"
"0","    mutate(treatment = 0)"
"0","  "
"0","  treatment_df <- treatment_df %>%"
"0","    st_drop_geometry() %>%"
"0","    mutate(treatment = 1)"
"0","  "
"0","  panel_data <- bind_rows(control_df, treatment_df) %>%"
"0","    mutate(project = project_name,"
"0","      intervention_year = intervention_year,"
"0","      post = ifelse(year >= intervention_year, 1, 0),"
"0","      time_to_intervention = year - intervention_year,"
"0","      did = treatment * post)"
"0","  "
"0","  panel_data <- panel_data %>%"
"0","    rename(income = lsoa_income_estimate,"
"0","      crime_rate = `crime rate`,"
"0","      house_price = median_price)"
"0","  "
"0","  panel_data <- panel_data %>%"
"0","    mutate(year = as.numeric(year),"
"0","      income = as.numeric(income),"
"0","      crime_rate = as.numeric(crime_rate),"
"0","      house_price = as.numeric(house_price),"
"0","      mobility = as.numeric(mobility))"
"0","  "
"0","  cat(""Data Summary:\n"")"
"0","  cat(""- Observations:"", nrow(panel_data), ""\n"")"
"0","  cat(""- LSOAs:"", n_distinct(panel_data$LSOA11CD), ""\n"")"
"0","  cat(""  Treatment:"", sum(panel_data$treatment == 1 & panel_data$year == 2011), ""\n"")"
"0","  cat(""  Control:"", sum(panel_data$treatment == 0 & panel_data$year == 2011), ""\n"")"
"0","  cat(""- Period:"", paste(range(panel_data$year), collapse = ""-""), ""\n"")"
"0","  cat(""- Intervention:"", intervention_year, ""\n\n"")"
"0","  "
"0","  return(panel_data)}"
"0",""
"0","test_parallel_trends_pretreatment <- function(panel_data, outcome_var, project_name) {"
"0","  "
"0","  intervention_year <- unique(panel_data$intervention_year)[1]"
"0",""
"0","  pre_data <- panel_data %>%"
"0","    filter(year < intervention_year, !is.na(!!sym(outcome_var)))"
"0","  "
"0","  if(nrow(pre_data) == 0) {"
"0","    cat(""Warning: No pre-treatment data available\n"")"
"0","    return(NULL)}"
"0",""
"0","  trend_test <- lm(as.formula(paste(outcome_var, ""~ treatment * year"")),"
"0","    data = pre_data)"
"0","  "
"0","  interaction_coef <- coef(trend_test)[""treatment:year""]"
"0","  interaction_se <- summary(trend_test)$coefficients[""treatment:year"", ""Std. Error""]"
"0","  interaction_pval <- summary(trend_test)$coefficients[""treatment:year"", ""Pr(>|t|)""]"
"0","  "
"0","  fe_results <- tryCatch({"
"0","    fe_model <- feols(as.formula(paste(outcome_var, ""~ treatment * year | LSOA11CD"")),"
"0","      data = pre_data,"
"0","      cluster = ~LSOA11CD)"
"0","    "
"0","    fe_tidy <- tidy(fe_model)"
"0","    fe_interaction <- fe_tidy %>% filter(term == ""treatment:year"")"
"0","    "
"0","    list(coef = fe_interaction$estimate[1],"
"0","      se = fe_interaction$std.error[1],"
"0","      pval = fe_interaction$p.value[1])}, error = function(e) {"
"0","    list(coef = NA, se = NA, pval = NA)})"
"0","  "
"0","  result <- list(outcome = outcome_var,"
"0","    project = project_name,"
"0","    simple_model = list(coefficient = interaction_coef,"
"0","      std_error = interaction_se,"
"0","      p_value = interaction_pval),"
"0","    fe_model = fe_results,"
"0","    pass_simple = interaction_pval > 0.05,"
"0","    pass_fe = ifelse(is.na(fe_results$pval), NA, fe_results$pval > 0.05),"
"0","    n_obs = nrow(pre_data),"
"0","    n_years_pre = n_distinct(pre_data$year))"
"0","  "
"0","  cat(""\nOutcome:"", outcome_var, ""\n"")"
"0","  cat(""Pre-treatment periods:"", n_distinct(pre_data$year), ""\n"")"
"0","  cat(""Differential trend coefficient:"", round(interaction_coef, 4), ""\n"")"
"0","  cat(""Standard error:"", round(interaction_se, 4), ""\n"")"
"0","  cat(""P-value:"", round(interaction_pval, 3), ""\n"")"
"0","  cat(""Result:"", ifelse(result$pass_simple, ""Parallel trends supported"", ""Parallel trends violated""), ""\n"")"
"0","  "
"0","  return(result)}"
"0",""
"0","plot_parallel_trends_academic <- function(panel_data, outcome_var, project_name, test_result = NULL) {"
"0","  "
"0","  intervention_year <- unique(panel_data$intervention_year)[1]"
"0","  "
"0",""
"0","  pre_trend_data <- panel_data %>%"
"0","    filter(year < intervention_year, !is.na(!!sym(outcome_var))) %>%"
"0","    group_by(year, treatment) %>%"
"0","    summarise("
"0","      mean_value = mean(!!sym(outcome_var), na.rm = TRUE),"
"0","      se = sd(!!sym(outcome_var), na.rm = TRUE) / sqrt(n()),"
"0","      ci_lower = mean_value - 1.96 * se,"
"0","      ci_upper = mean_value + 1.96 * se,"
"0","      n = n(),"
"0","      .groups = ""drop"") %>%"
"0","    mutate(Group = factor(ifelse(treatment == 1, ""Treatment"", ""Control""),"
"0","                    levels = c(""Treatment"", ""Control"")))"
"0",""
"0","  y_label <- case_when("
"0","    outcome_var == ""income"" ~ ""Income (GBP)"","
"0","    outcome_var == ""crime_rate"" ~ ""Crime Rate per Capita"","
"0","    outcome_var == ""house_price"" ~ ""Median House Price (GBP)"","
"0","    outcome_var == ""mobility"" ~ ""Residential Mobility Rate"","
"0","    TRUE ~ str_to_title(gsub(""_"", "" "", outcome_var)))"
"0","  "
"0","  # Create subtitle with test results"
"0","  subtitle_text <- ifelse("
"0","    !is.null(test_result),"
"0","    paste0(""Pre-treatment differential trend: "", "
"0","           sprintf(""%.2e"", test_result$simple_model$coefficient),"
"0","           "", p = "", sprintf(""%.3f"", test_result$simple_model$p_value)),"
"0","    ""Pre-treatment period analysis"")"
"0","  "
"0",""
"0","  p <- ggplot(pre_trend_data, aes(x = year, y = mean_value, group = Group)) +"
"0",""
"0","    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, fill = Group),"
"0","               alpha = 0.15, color = NA) +"
"0",""
"0","    geom_line(aes(color = Group), size = 0.8) +"
"0",""
"0","    geom_point(aes(color = Group, shape = Group), size = 2) +"
"0",""
"0","    labs(title = paste0(""Figure: Pre-treatment Trends in "", "
"0","                    str_to_title(gsub(""_"", "" "", outcome_var)), "" ("", project_name, "")""),"
"0","      subtitle = subtitle_text,"
"0","      x = ""Year"","
"0","      y = y_label,"
"0","      caption = paste(""Note: Shaded areas represent 95% confidence intervals."","
"0","                     ""Sample includes"", n_distinct(panel_data$LSOA11CD), ""LSOAs."")) +"
"0",""
"0","    theme_ucl() +"
"0",""
"0","    scale_color_manual(values = c(""Treatment"" = ""#D32F2F"", ""Control"" = ""#1976D2"")) +"
"0","    scale_fill_manual(values = c(""Treatment"" = ""#D32F2F"", ""Control"" = ""#1976D2"")) +"
"0","    scale_shape_manual(values = c(""Treatment"" = 16, ""Control"" = 17)) +"
"0",""
"0","    scale_x_continuous("
"0","      breaks = seq(min(pre_trend_data$year), max(pre_trend_data$year), by = 1),"
"0","      minor_breaks = NULL"
"0","    ) + scale_y_continuous(labels = scales::comma)"
"0","  "
"0","  return(p)}"
"0",""
"0","comprehensive_parallel_trends_analysis <- function(control_df, treatment_df, project_name) {"
"0","  "
"0","  panel_data <- prepare_panel_for_analysis(control_df, treatment_df, project_name)"
"0","  "
"0","  outcomes <- c(""income"", ""crime_rate"", ""house_price"", ""mobility"")"
"0","  "
"0","  test_results <- list()"
"0","  plots <- list()"
"0","  "
"0","  for(outcome in outcomes) {"
"0","    "
"0","    cat(""\n---"", str_to_title(gsub(""_"", "" "", outcome)), ""---\n"")"
"0","    "
"0","    test_result <- test_parallel_trends_pretreatment(panel_data, outcome, project_name)"
"0","    "
"0","    if(!is.null(test_result)) {"
"0","      test_results[[outcome]] <- test_result"
"0","      "
"0","      p <- plot_parallel_trends_academic(panel_data, outcome, project_name, test_result)"
"0","      plots[[outcome]] <- p}}"
"0",""
"0","  summary_table <- map_df(test_results, function(x) {"
"0","    data.frame("
"0","      Outcome = str_to_title(gsub(""_"", "" "", x$outcome)),"
"0","      Coefficient = x$simple_model$coefficient,"
"0","      SE = x$simple_model$std_error,"
"0","      t_statistic = x$simple_model$coefficient / x$simple_model$std_error,"
"0","      P_Value = x$simple_model$p_value,"
"0","      N_Obs = x$n_obs,"
"0","      Pre_Years = x$n_years_pre,"
"0","      Result = ifelse(x$pass_simple, ""Supported"", ""Violated""),"
"0","      stringsAsFactors = FALSE)})"
"0","  "
"0","  cat(""\n\nPARALLEL TRENDS TEST RESULTS\n"")"
"0","  cat(""========================================\n"")"
"0","  print(summary_table, digits = 4)"
"0","  "
"0","  return(list(panel_data = panel_data,"
"0","    test_results = test_results,"
"0","    plots = plots,"
"0","    summary = summary_table))}"
"0",""
"0","nle_analysis <- comprehensive_parallel_trends_analysis("
"0","  control_df = nle_matched_metrics,"
"0","  treatment_df = nle_affected_metrics,"
"0","  project_name = ""NLE"")"
"1","Data Summary:
"
"1","- Observations:"
"1"," "
"1","1260"
"1"," "
"1","
"
"1","- LSOAs:"
"1"," "
"1","105"
"1"," "
"1","
"
"1","  Treatment:"
"1"," "
"1","35"
"1"," "
"1","
"
"1","  Control:"
"1"," "
"1","70"
"1"," "
"1","
"
"1","- Period:"
"1"," "
"1","2011-2022"
"1"," "
"1","
"
"1","- Intervention:"
"1"," "
"1","2015"
"1"," "
"1","

"
"1","
---"
"1"," "
"1","Income"
"1"," "
"1","---
"
"2","The variable 'treatment' has been removed because of collinearity (see $collin.var).
"
"1","
Outcome:"
"1"," "
"1","income"
"1"," "
"1","
"
"1","Pre-treatment periods:"
"1"," "
"1","4"
"1"," "
"1","
"
"1","Differential trend coefficient:"
"1"," "
"1","-336.0144"
"1"," "
"1","
"
"1","Standard error:"
"1"," "
"1","727.4434"
"1"," "
"1","
"
"1","P-value:"
"1"," "
"1","0.644"
"1"," "
"1","
"
"1","Result:"
"1"," "
"1","Parallel trends supported"
"1"," "
"1","
"
"1","
---"
"1"," "
"1","Crime Rate"
"1"," "
"1","---
"
"2","The variable 'treatment' has been removed because of collinearity (see $collin.var).
"
"1","
Outcome:"
"1"," "
"1","crime_rate"
"1"," "
"1","
"
"1","Pre-treatment periods:"
"1"," "
"1","4"
"1"," "
"1","
"
"1","Differential trend coefficient:"
"1"," "
"1","0.0047"
"1"," "
"1","
"
"1","Standard error:"
"1"," "
"1","0.0077"
"1"," "
"1","
"
"1","P-value:"
"1"," "
"1","0.542"
"1"," "
"1","
"
"1","Result:"
"1"," "
"1","Parallel trends supported"
"1"," "
"1","
"
"1","
---"
"1"," "
"1","House Price"
"1"," "
"1","---
"
"2","The variable 'treatment' has been removed because of collinearity (see $collin.var).
"
"1","
Outcome:"
"1"," "
"1","house_price"
"1"," "
"1","
"
"1","Pre-treatment periods:"
"1"," "
"1","4"
"1"," "
"1","
"
"1","Differential trend coefficient:"
"1"," "
"1","2933.207"
"1"," "
"1","
"
"1","Standard error:"
"1"," "
"1","16255.74"
"1"," "
"1","
"
"1","P-value:"
"1"," "
"1","0.857"
"1"," "
"1","
"
"1","Result:"
"1"," "
"1","Parallel trends supported"
"1"," "
"1","
"
"1","
---"
"1"," "
"1","Mobility"
"1"," "
"1","---
"
"2","The variable 'treatment' has been removed because of collinearity (see $collin.var).
"
"1","
Outcome:"
"1"," "
"1","mobility"
"1"," "
"1","
"
"1","Pre-treatment periods:"
"1"," "
"1","4"
"1"," "
"1","
"
"1","Differential trend coefficient:"
"1"," "
"1","1e-04"
"1"," "
"1","
"
"1","Standard error:"
"1"," "
"1","0.0108"
"1"," "
"1","
"
"1","P-value:"
"1"," "
"1","0.992"
"1"," "
"1","
"
"1","Result:"
"1"," "
"1","Parallel trends supported"
"1"," "
"1","
"
"1","

PARALLEL TRENDS TEST RESULTS
"
"1","========================================
"
