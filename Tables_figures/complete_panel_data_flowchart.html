<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<style>
body {
    background-color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    line-height: 1.4;
}

.container {
    width: 100%;
    max-width: 1600px;
    margin: 0 auto;
}

.main-title {
    font-size: 22pt;
    font-weight: bold;
    text-align: center;
    margin-bottom: 30px;
    color: #2c3e50;
    border-bottom: 3px solid #3498db;
    padding-bottom: 15px;
}

.stage-container {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.stage {
    border: 2px solid #34495e;
    border-radius: 15px;
    padding: 25px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    position: relative;
}

.stage-header {
    background: #34495e;
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 16pt;
    font-weight: bold;
    margin: -25px -25px 20px -25px;
    text-align: center;
}

.content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.content-box {
    border: 1px solid #bdc3c7;
    border-radius: 10px;
    padding: 20px;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.content-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.content-title {
    font-size: 14pt;
    font-weight: bold;
    color: #2980b9;
    margin-bottom: 15px;
    border-bottom: 2px solid #3498db;
    padding-bottom: 8px;
}

.step-list {
    list-style: none;
    padding-left: 0;
    margin: 10px 0;
}

.step-list li {
    padding: 5px 0;
    position: relative;
    padding-left: 20px;
}

.step-list li::before {
    content: "▶";
    color: #3498db;
    font-weight: bold;
    position: absolute;
    left: 0;
}

.highlight-box {
    background: #e8f6f3;
    border-left: 4px solid #16a085;
    padding: 15px;
    margin: 15px 0;
    border-radius: 5px;
}

.code-snippet {
    background: #2c3e50;
    color: #ecf0f1;
    padding: 12px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-size: 10pt;
    overflow-x: auto;
    margin: 10px 0;
}

.methods-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.method-card {
    border: 1px solid #e74c3c;
    border-radius: 8px;
    padding: 15px;
    background: linear-gradient(135deg, #fff5f5 0%, #ffebee 100%);
    text-align: center;
    transition: transform 0.2s;
}

.method-card:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);
}

.method-card.spatial {
    border-color: #27ae60;
    background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
}

.method-card.robust {
    border-color: #f39c12;
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
}

.method-name {
    font-size: 12pt;
    font-weight: bold;
    margin-bottom: 8px;
}

.method-desc {
    font-size: 10pt;
    color: #555;
}

.spatial-weights {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.weight-type {
    border: 2px solid #3498db;
    border-radius: 10px;
    padding: 15px;
    background: linear-gradient(135deg, #ebf3fd 0%, #dae8fc 100%);
}

.weight-title {
    font-size: 13pt;
    font-weight: bold;
    color: #2980b9;
    margin-bottom: 10px;
    text-align: center;
}

.flow-arrow {
    text-align: center;
    font-size: 28pt;
    color: #3498db;
    margin: 20px 0;
    font-weight: bold;
}

.validation-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 25px;
    margin-top: 20px;
}

.validation-box {
    border: 1px solid #8e44ad;
    border-radius: 10px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f4fd 0%, #e8d5f0 100%);
}

.validation-title {
    font-size: 13pt;
    font-weight: bold;
    color: #8e44ad;
    margin-bottom: 12px;
    text-align: center;
}

.results-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 15px;
    margin-top: 30px;
}

.summary-title {
    font-size: 16pt;
    font-weight: bold;
    text-align: center;
    margin-bottom: 20px;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.metric-item {
    background: rgba(255,255,255,0.2);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
}

.metric-value {
    font-size: 16pt;
    font-weight: bold;
    display: block;
}

.metric-label {
    font-size: 10pt;
    opacity: 0.9;
}

.improvement-box {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    border-left: 4px solid #fdcb6e;
}

.improvement-title {
    font-weight: bold;
    color: #d68910;
    margin-bottom: 8px;
}
</style>
</head>
<body>

<div class="container">
    <div class="main-title">
        Stage 3: Panel Data Analysis - Multi-Method DID Framework
    </div>
    
    <div class="stage-container">
        <!-- Stage 3.1: Panel Data Construction -->
        <div class="stage">
            <div class="stage-header">3.1 Panel Data Construction</div>
            
            <div class="content-grid">
                <div class="content-box">
                    <div class="content-title">Four Outcome Variables Integration</div>
                    <div class="highlight-box">
                        <strong>Outcome Variables:</strong>
                        <ul class="step-list">
                            <li><strong>income:</strong> LSOA-level income estimates (£/year)</li>
                            <li><strong>crime_rate:</strong> Population-weighted crime rates</li>
                            <li><strong>house_price:</strong> Median house prices (£)</li>
                            <li><strong>mobility:</strong> Residential mobility indices</li>
                        </ul>
                    </div>
                </div>
                
                <div class="content-box">
                    <div class="content-title">Pre-treatment Trends Verification</div>
                    <div class="code-snippet">
test_parallel_trends_pretreatment <- function(panel_data, outcome_var) {
  trend_test <- lm(outcome ~ treatment * year, data = pre_data)
  interaction_pval <- summary(trend_test)$coefficients["treatment:year", "Pr(>|t|)"]
  return(interaction_pval > 0.05)  # Pass if p > 0.05
}
                    </div>
                </div>
                
                <div class="content-box">
                    <div class="content-title">Enhanced Control Variables</div>
                    <div class="improvement-box">
                        <div class="improvement-title">Key Improvements:</div>
                        <ul class="step-list">
                            <li>Population density controls added</li>
                            <li>Geographic distance controls</li>
                            <li>COVID period handling (2020-2021)</li>
                            <li>Missing value interpolation</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flow-arrow">↓</div>
        
        <!-- Stage 3.2: Spatial Weight Matrices -->
        <div class="stage">
            <div class="stage-header">3.2 Spatial Weight Matrices Construction</div>
            
            <div class="spatial-weights">
                <div class="weight-type">
                    <div class="weight-title">K-Nearest Neighbors (KNN)</div>
                    <div class="highlight-box">
                        <strong>KNN Weight Construction:</strong>
                        <ul class="step-list">
                            <li><strong>KNN-5:</strong> Primary analysis (★★★★★)</li>
                            <li><strong>KNN-10:</strong> Robustness check (★★★★☆)</li>
                            <li>Fixed neighbor count for consistent spillovers</li>
                            <li>Row-standardized weights (style="W")</li>
                        </ul>
                    </div>
                    <div class="code-snippet">
k_values <- c(5, 10)
nb_knn <- knn2nb(knearneigh(coords, k = k))
W_knn <- nb2listw(nb_knn, style = "W", zero.policy = TRUE)
                    </div>
                </div>
                
                <div class="weight-type">
                    <div class="weight-title">Distance Threshold Weights</div>
                    <div class="highlight-box">
                        <strong>Distance-Based Weights:</strong>
                        <ul class="step-list">
                            <li><strong>Short Distance:</strong> median_dist/2 (★★★★☆)</li>
                            <li><strong>Medium Distance:</strong> median_dist (★★★★★)</li>
                            <li><strong>Long Distance:</strong> median_dist×2 (★★★☆☆)</li>
                            <li>Isolated points handling with nearest neighbor</li>
                        </ul>
                    </div>
                    <div class="code-snippet">
thresholds <- c(median_dist/2, median_dist, median_dist*2)
nb_dist <- dnearneigh(coords, 0, thresh)
W_dist <- nb2listw(nb_dist, style = "W", zero.policy = TRUE)
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flow-arrow">↓</div>
        
        <!-- Stage 3.3: Multi-Method Estimation -->
        <div class="stage">
            <div class="stage-header">3.3 Multi-Method Estimation Framework (10 Methods)</div>
            
            <div class="methods-grid">
                <!-- Basic DID Methods -->
                <div class="method-card">
                    <div class="method-name">Simple DID</div>
                    <div class="method-desc">Basic difference-in-differences with population density controls</div>
                </div>
                
                <div class="method-card">
                    <div class="method-name">Standard DID</div>
                    <div class="method-desc">Two-way fixed effects with clustered standard errors</div>
                </div>
                
                <div class="method-card">
                    <div class="method-name">No COVID</div>
                    <div class="method-desc">Robustness check excluding 2020-2021 periods</div>
                </div>
                
                <!-- Spatial Methods -->
                <div class="method-card spatial">
                    <div class="method-name">SLM</div>
                    <div class="method-desc">Spatial Lag Model - Direct effects + Indirect + Total</div>
                </div>
                
                <div class="method-card spatial">
                    <div class="method-name">SEM</div>
                    <div class="method-desc">Spatial Error Model - Spatial correlation controls</div>
                </div>
                
                <div class="method-card spatial">
                    <div class="method-name">SDM</div>
                    <div class="method-desc">Spatial Durbin Model - Local + spatial effects</div>
                </div>
                
                <!-- Advanced Methods -->
                <div class="method-card robust">
                    <div class="method-name">Event Study</div>
                    <div class="method-desc">Dynamic treatment effects over time</div>
                </div>
                
                <div class="method-card robust">
                    <div class="method-name">Synthetic Control</div>
                    <div class="method-desc">Small sample method (n≤15)</div>
                </div>
                
                <div class="method-card robust">
                    <div class="method-name">DR-DID</div>
                    <div class="method-desc">Doubly Robust difference-in-differences</div>
                </div>
                
                <div class="method-card robust">
                    <div class="method-name">Bootstrap</div>
                    <div class="method-desc">Non-parametric confidence intervals</div>
                </div>
            </div>
            
            <div class="highlight-box" style="margin-top: 20px;">
                <strong>Convergence Validation Protocol:</strong>
                <ul class="step-list">
                    <li>Automatic error handling with graceful fallbacks</li>
                    <li>Coefficient stability checks across weight matrices</li>
                    <li>Small sample size adaptations (n≤15 → Synthetic Control)</li>
                    <li>Bootstrap replication validation (R=500)</li>
                </ul>
            </div>
        </div>
        
        <div class="flow-arrow">↓</div>
        
        <!-- Stage 3.4: Robustness Testing -->
        <div class="stage">
            <div class="stage-header">3.4 Comprehensive Robustness Testing</div>
            
            <div class="validation-grid">
                <div class="validation-box">
                    <div class="validation-title">Method Convergence Comparison</div>
                    <div class="highlight-box">
                        <strong>Cross-Method Validation:</strong>
                        <ul class="step-list">
                            <li>Coefficient consistency across methods</li>
                            <li>Standard error stability checks</li>
                            <li>Significance pattern validation</li>
                            <li>Outlier identification and handling</li>
                        </ul>
                    </div>
                </div>
                
                <div class="validation-box">
                    <div class="validation-title">Small Sample Adaptivity</div>
                    <div class="highlight-box">
                        <strong>Adaptive Design Features:</strong>
                        <ul class="step-list">
                            <li><strong>n=1:</strong> Synthetic Control recommended</li>
                            <li><strong>n≤3:</strong> Bootstrap CI priority</li>
                            <li><strong>n≤15:</strong> Enhanced Synthetic Control</li>
                            <li><strong>n>15:</strong> Full method suite</li>
                        </ul>
                    </div>
                </div>
                
                <div class="validation-box">
                    <div class="validation-title">Spatial Weight Sensitivity</div>
                    <div class="highlight-box">
                        <strong>Multiple Weight Comparison:</strong>
                        <ul class="step-list">
                            <li>KNN-5 vs KNN-10 consistency</li>
                            <li>Distance threshold robustness</li>
                            <li>Coefficient variation analysis</li>
                            <li>Optimal weight selection criteria</li>
                        </ul>
                    </div>
                    <div class="code-snippet">
# Spatial robustness check
slm_cv <- sd(slm_effects) / abs(mean(slm_effects))
if(slm_cv < 0.1) "Highly Robust" 
else if(slm_cv < 0.3) "Moderately Robust" 
else "Not Robust"
                    </div>
                </div>
                
                <div class="validation-box">
                    <div class="validation-title">Statistical Inference Validation</div>
                    <div class="highlight-box">
                        <strong>Inference Framework:</strong>
                        <ul class="step-list">
                            <li>Clustered standard errors (LSOA level)</li>
                            <li>Bootstrap confidence intervals (500 reps)</li>
                            <li>Wild bootstrap for small samples</li>
                            <li>Multiple testing corrections</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="results-summary">
        <div class="summary-title">Stage 3 Framework Deliverables</div>
        
        <div class="metrics-grid">
            <div class="metric-item">
                <span class="metric-value">10</span>
                <span class="metric-label">Estimation Methods</span>
            </div>
            <div class="metric-item">
                <span class="metric-value">5+</span>
                <span class="metric-label">Spatial Weights</span>
            </div>
            <div class="metric-item">
                <span class="metric-value">4</span>
                <span class="metric-label">Outcome Variables</span>
            </div>
            <div class="metric-item">
                <span class="metric-value">500</span>
                <span class="metric-label">Bootstrap Reps</span>
            </div>
            <div class="metric-item">
                <span class="metric-value">2011-2022</span>
                <span class="metric-label">Panel Period</span>
            </div>
            <div class="metric-item">
                <span class="metric-value">Auto-QC</span>
                <span class="metric-label">Convergence Check</span>
            </div>
            <div class="metric-item">
                <span class="metric-value">Pop Density</span>
                <span class="metric-label">Enhanced Controls</span>
            </div>
            <div class="metric-item">
                <span class="metric-value">COVID Robust</span>
                <span class="metric-label">Period Handling</span>
            </div>
        </div>
        
        <div style="margin-top: 25px; text-align: center;">
            <div style="font-size: 14pt; font-weight: bold; margin-bottom: 10px;">
                🎯 Output: Comprehensive Multi-Method Comparison Tables
            </div>
            <div style="font-size: 12pt;">
                <strong>Ready for:</strong> Policy Impact Assessment • Spatial Effect Analysis • Academic Publication • Robustness Documentation
            </div>
        </div>
    </div>
</div>

</body>
</html>